# 📋 機能詳細仕様書
# おつかいポイント MVP版

---

## 📄 文書情報

| 項目 | 内容 |
|------|------|
| **文書タイトル** | おつかいポイント 機能詳細仕様書 |
| **バージョン** | v1.1 |
| **作成日** | 2025年09月21日 |
| **最終更新** | 2025年09月22日 |
| **承認状況** | ドラフト |
| **対象読者** | 全エンジニア系職種（システムアーキテクト、ビジネスロジック担当、フロントエンドエンジニア、DevOpsエンジニア、QAエンジニア） |
| **前提文書** | プロダクト要求仕様書 (PRD) v1.1 |

---

## 🎯 1. 概要

### 1.1 文書の目的
本文書は、おつかいポイントMVP版の機能要件をエンジニア向けに詳細化し、実装に必要な技術仕様を明確に定義することを目的とする。

### 1.2 スコープ
- 各機能の詳細動作仕様
- 画面別操作フロー
- 入力検証ルール
- エラーハンドリング方針
- 業務ルール詳細
- API仕様概要

### 1.3 参照文書
- プロダクト要求仕様書 (PRD) v1.0
- システムアーキテクチャ設計書（作成予定）
- データベース基本設計書（作成予定）

---

## 🏗️ 2. システム全体構成

### 2.1 技術スタック（PRD準拠）
- **フロントエンド**: Flutter 3.8+
- **言語**: Dart 3.0+
- **バックエンド**: Supabase
- **データベース**: PostgreSQL（Supabase管理）
- **状態管理**: Riverpod 2.5+
- **認証**: Google OAuth（Supabase Auth）

### 2.3 アーキテクチャ方針（PRD 5.2準拠）
- **Clean Architecture**: ビジネスロジックとUI分離
- **Repository Pattern**: データアクセス層の抽象化
- **Provider Pattern**: 依存性注入とテスタビリティ
- **モジュラー設計**: 機能別独立モジュール化による拡張性確保

### 2.4 拡張性設計要件（PRD 6.5準拠）
- **新機能追加時の既存コード変更率**: 20%以下
- **機能別独立性**: モジュール間の依存関係最小化
- **プラグイン型設計**: 新機能の独立開発・テスト可能
- **API拡張性**: 後方互換性を保った機能追加

### 2.5 アプリケーション構成
```
┌─────────────────────────────────────┐
│           Flutter アプリ             │
├─────────────────────────────────────┤
│  親用画面         │     子用画面     │
│ ┌─────────────┐   │ ┌─────────────┐ │
│ │ ログイン      │   │ │ ログイン      │ │
│ │ ホーム       │   │ │ QRスキャナー  │ │
│ │ 商品編集     │   │ │ リスト表示    │ │
│ └─────────────┘   │ └─────────────┘ │
├─────────────────────────────────────┤
│         状態管理（Riverpod）         │
├─────────────────────────────────────┤
│          Supabase Client            │
└─────────────────────────────────────┘
              ↓ HTTPS
┌─────────────────────────────────────┐
│            Supabase                 │
│ ┌─────────────┬─────────────────┐   │
│ │ Auth        │ Realtime        │   │
│ │ (Google)    │ Subscriptions   │   │
│ ├─────────────┼─────────────────┤   │
│ │       PostgreSQL DB         │   │
│ │   ┌─────────────────────┐   │   │
│ │   │ users, families,    │   │   │
│ │   │ shopping_lists,     │   │   │
│ │   │ shopping_items      │   │   │
│ │   └─────────────────────┘   │   │
│ └─────────────────────────────┘   │
└─────────────────────────────────────┘
```

---

## 🔐 3. 認証・アカウント管理機能詳細

### 3.1 機能要件（PRD 3.2.1準拠）
| 機能ID | 機能名 | 詳細 |
|--------|--------|------|
| AUTH-001 | Google OAuth認証 | Google アカウントでのログイン |
| AUTH-002 | 初回ユーザー登録 | 名前・役割（親/子）の設定 |

### 3.2 Google OAuth認証（AUTH-001）

#### 3.2.1 機能概要
Supabase AuthとGoogle OAuth 2.0を使用したシングルサインオン認証

#### 3.2.2 詳細動作フロー
```
1. ユーザーがログイン画面で「Googleでログイン」ボタンをタップ
2. Flutter → Supabase Auth → Google OAuth画面へリダイレクト
3. ユーザーがGoogle認証情報を入力
4. Google → Supabase Auth → Flutter へトークン返却
5. Supabase Auth JWTトークンを生成
6. アプリケーション状態にユーザー情報を保存
7. 初回登録の場合 → ユーザー登録画面へ
8. 既存ユーザーの場合 → ホーム画面へ
```

#### 3.2.3 技術仕様
```dart
// Supabase Auth 設定例
final supabase = Supabase.instance.client;

// Google OAuth ログイン
Future<AuthResponse> signInWithGoogle() async {
  return await supabase.auth.signInWithOAuth(
    Provider.google,
    redirectTo: 'com.example.otsukaipoint://login-callback',
  );
}
```

#### 3.2.4 成功条件
- Google認証が成功し、有効なJWTトークンが取得できる
- ユーザー情報が正常にアプリケーション状態に保存される
- ネットワークエラー時に適切なエラーメッセージが表示される

#### 3.2.5 エラーハンドリング
| エラー種類 | 条件 | 表示メッセージ | 対応動作 |
|-----------|------|-------------|---------|
| ネットワークエラー | インターネット接続なし | 「インターネット接続を確認してください」 | リトライボタン表示 |
| 認証キャンセル | ユーザーが認証をキャンセル | 「ログインがキャンセルされました」 | ログイン画面に戻る |
| 認証失敗 | Google認証エラー | 「ログインに失敗しました」 | ログイン画面に戻る |
| Supabaseエラー | サーバーエラー | 「しばらく時間をおいて再度お試しください」 | ログイン画面に戻る |

### 3.3 初回ユーザー登録（AUTH-002）

#### 3.3.1 機能概要
Google OAuth認証成功後の初回ユーザー情報登録

#### 3.3.2 詳細動作フロー
```
1. Google OAuth認証成功（初回ユーザー）
2. 初回登録画面を表示
3. ユーザー名入力（必須、1-20文字）
4. 役割選択（必須、「親」または「子」）
5. 「登録」ボタンタップ
6. 入力内容をバリデーション
7. Supabase usersテーブルにユーザー情報を保存
8. 役割に応じたホーム画面へ遷移
```

#### 3.3.3 入力検証ルール
| 項目 | 検証ルール | エラーメッセージ |
|------|-----------|----------------|
| ユーザー名 | 必須入力 | 「ユーザー名を入力してください」 |
| ユーザー名 | 1-20文字 | 「ユーザー名は1-20文字で入力してください」 |
| ユーザー名 | 重複チェック | 「このユーザー名は既に使用されています」 |
| 役割 | 必須選択 | 「役割を選択してください」 |

#### 3.3.4 データベース保存仕様
```sql
-- usersテーブル構造例
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  auth_id UUID REFERENCES auth.users(id),
  name VARCHAR(20) NOT NULL,
  role VARCHAR(10) NOT NULL CHECK (role IN ('parent', 'child')),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

---

## 📱 4. QRコード機能詳細

### 4.1 機能要件（PRD 3.2.2準拠）
| 機能ID | 機能名 | 詳細 |
|--------|--------|------|
| FAMILY-001 | QRコード生成 | 一意なQRコードを自動生成・表示 |
| FAMILY-002 | QRコードスキャン | QRコードスキャンで家族グループに参加 |
| FAMILY-003 | 家族メンバー表示 | 参加中の家族メンバー一覧表示 |

### 4.2 QRコード生成（FAMILY-001）

#### 4.2.1 機能概要
親ユーザーが家族グループへの参加用QRコードを生成・表示

#### 4.2.2 詳細動作フロー
```
1. 親ユーザーがホーム画面を表示
2. 家族グループが未作成の場合、自動的に家族グループを生成
3. 家族グループの一意識別子（family_id）を含むQRコードを生成
4. QRコードをホーム画面に表示
5. QRコード下に「QRコードを見せて家族を招待」説明文を表示
```

#### 4.2.3 QRコード生成仕様
```dart
// QRコード生成ライブラリ例
import 'package:qr_flutter/qr_flutter.dart';

// QRコード データ形式
final qrData = 'otsukaipoint://join/${familyId}';

// QRコード Widget
QrImageView(
  data: qrData,
  version: QrVersions.auto,
  size: 200.0,
  backgroundColor: Colors.white,
)
```

#### 4.2.4 家族グループ生成仕様
```sql
-- familiesテーブル構造例
CREATE TABLE families (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- family_membersテーブル構造例
CREATE TABLE family_members (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  family_id UUID REFERENCES families(id),
  user_id UUID REFERENCES users(id),
  joined_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(family_id, user_id)
);
```

### 4.3 QRコードスキャン（FAMILY-002）

#### 4.3.1 機能概要
子ユーザーがQRコードをスキャンして家族グループに参加

#### 4.3.2 詳細動作フロー
```
1. 子ユーザーがQRコードスキャナー画面を表示
2. カメラ権限を要求・確認
3. QRコードスキャナーを起動
4. QRコードを検出・デコード
5. データ形式を検証（otsukaipoint://join/{family_id}）
6. family_idの存在確認
7. 既に参加済みでないことを確認
8. family_membersテーブルに参加記録を追加
9. 「家族グループに参加しました」メッセージ表示
10. リスト表示画面へ遷移
```

#### 4.3.3 QRコードスキャン仕様
```dart
// QRコードスキャンライブラリ例
import 'package:mobile_scanner/mobile_scanner.dart';

// QRコード検出処理
void onDetect(BarcodeCapture capture) {
  final List<Barcode> barcodes = capture.barcodes;
  for (final barcode in barcodes) {
    final String? code = barcode.rawValue;
    if (code != null && code.startsWith('otsukaipoint://join/')) {
      // family_id を抽出して家族参加処理
      final familyId = code.split('/').last;
      joinFamily(familyId);
    }
  }
}
```

#### 4.3.4 入力検証・エラーハンドリング
| エラー種類 | 条件 | 表示メッセージ | 対応動作 |
|-----------|------|-------------|---------|
| カメラ権限なし | カメラアクセス拒否 | 「カメラの使用を許可してください」 | 設定画面への誘導 |
| 無効なQRコード | データ形式不正 | 「正しいQRコードを読み取ってください」 | スキャン継続 |
| 存在しない家族ID | family_id不存在 | 「有効でないQRコードです」 | スキャン継続 |
| 既に参加済み | 重複参加 | 「既にこの家族に参加しています」 | リスト画面へ遷移 |
| ネットワークエラー | 接続失敗 | 「インターネット接続を確認してください」 | リトライボタン表示 |

### 4.4 家族メンバー表示（FAMILY-003）

#### 4.4.1 機能概要
家族グループに参加中のメンバー一覧を表示

#### 4.4.2 表示仕様
- ホーム画面の一部として家族メンバー一覧を表示
- 各メンバーの名前と役割（親/子）を表示
- リアルタイムで参加・離脱を反映

#### 4.4.3 データ取得仕様
```sql
-- 家族メンバー取得クエリ例
SELECT u.name, u.role, fm.joined_at 
FROM family_members fm
JOIN users u ON fm.user_id = u.id
WHERE fm.family_id = $1
ORDER BY fm.joined_at ASC;
```

---

## 🛒 5. お買い物リスト管理機能詳細

### 5.1 機能要件（PRD 3.2.3準拠）
| 機能ID | 機能名 | 詳細 | 対象ユーザー |
|--------|--------|------|-------------|
| LIST-001 | リスト作成 | 新しいお買い物リストの作成 | 親 |
| LIST-002 | 商品追加 | 商品名をテキスト入力で追加 | 親 |
| LIST-003 | 商品編集 | 商品名の変更 | 親 |
| LIST-004 | 商品削除 | 商品をリストから削除 | 親 |
| LIST-005 | リスト表示 | 現在のお買い物リスト表示 | 親・子 |
| LIST-006 | 商品完了 | 商品を「完了」状態に変更 | 子 |
| LIST-007 | 進捗確認 | 完了/未完了の状況確認 | 親 |

### 5.2 リスト作成（LIST-001）

#### 5.2.1 機能概要
親ユーザーが新しいお買い物リストを作成

#### 5.2.2 詳細動作フロー
```
1. 親ユーザーがホーム画面で「新しいリスト作成」ボタンをタップ
2. リスト名入力ダイアログを表示
3. リスト名を入力（必須、1-50文字）
4. 「作成」ボタンをタップ
5. 入力内容をバリデーション
6. shopping_listsテーブルに新しいリストを保存
7. 作成したリストをアクティブリストに設定
8. ホーム画面を更新表示
```

#### 5.2.3 入力検証ルール
| 項目 | 検証ルール | エラーメッセージ |
|------|-----------|----------------|
| リスト名 | 必須入力 | 「リスト名を入力してください」 |
| リスト名 | 1-50文字 | 「リスト名は1-50文字で入力してください」 |

#### 5.2.4 データベース仕様
```sql
-- shopping_listsテーブル構造例
CREATE TABLE shopping_lists (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  family_id UUID REFERENCES families(id),
  name VARCHAR(50) NOT NULL,
  created_by UUID REFERENCES users(id),
  status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'completed', 'archived')),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### 5.3 商品追加（LIST-002）

#### 5.3.1 機能概要
親ユーザーがアクティブなお買い物リストに商品を追加

#### 5.3.2 詳細動作フロー
```
1. 親ユーザーがホーム画面で「商品追加」ボタンをタップ
2. 商品追加画面を表示
3. 商品名を入力（必須、1-30文字）
4. 「追加」ボタンをタップ
5. 入力内容をバリデーション
6. shopping_itemsテーブルに商品を保存
7. リアルタイム同期で他のデバイスに通知
8. ホーム画面のリスト表示を更新
```

#### 5.3.3 入力検証ルール
| 項目 | 検証ルール | エラーメッセージ |
|------|-----------|----------------|
| 商品名 | 必須入力 | 「商品名を入力してください」 |
| 商品名 | 1-30文字 | 「商品名は1-30文字で入力してください」 |
| 商品名 | 同一リスト内重複禁止 | 「この商品は既にリストに追加されています」 |

#### 5.3.4 データベース仕様
```sql
-- shopping_itemsテーブル構造例
CREATE TABLE shopping_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  shopping_list_id UUID REFERENCES shopping_lists(id),
  name VARCHAR(30) NOT NULL,
  status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'completed')),
  completed_by UUID REFERENCES users(id),
  completed_at TIMESTAMP,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(shopping_list_id, name)
);
```

### 5.4 商品編集（LIST-003）

#### 5.4.1 機能概要
親ユーザーが既存商品の名前を変更

#### 5.4.2 詳細動作フロー
```
1. 親ユーザーがホーム画面のリストで商品をロングタップ
2. コンテキストメニューで「編集」を選択
3. 商品編集ダイアログを表示（現在の商品名がプリセット）
4. 商品名を編集（必須、1-30文字）
5. 「保存」ボタンをタップ
6. 入力内容をバリデーション
7. shopping_itemsテーブルの商品名を更新
8. リアルタイム同期で他のデバイスに通知
9. ホーム画面のリスト表示を更新
```

### 5.5 商品削除（LIST-004）

#### 5.5.1 機能概要
親ユーザーが商品をリストから削除

#### 5.5.2 詳細動作フロー
```
1. 親ユーザーがホーム画面のリストで商品をロングタップ
2. コンテキストメニューで「削除」を選択
3. 削除確認ダイアログを表示
4. 「削除する」ボタンをタップ
5. shopping_itemsテーブルから商品を削除
6. リアルタイム同期で他のデバイスに通知
7. ホーム画面のリスト表示を更新
```

### 5.6 リスト表示（LIST-005）

#### 5.6.1 機能概要
親・子ユーザーが現在のお買い物リストを表示

#### 5.6.2 表示仕様
- アクティブなお買い物リストの全商品を表示
- 各商品の完了状態（完了/未完了）を視覚的に表示
- 完了済み商品は取り消し線で表示
- 完了者の名前を表示（完了済みの場合）
- リアルタイムで状態変更を反映

#### 5.6.3 データ取得仕様
```sql
-- アクティブリスト商品取得クエリ例
SELECT 
  si.id, si.name, si.status, si.completed_at,
  u.name as completed_by_name
FROM shopping_items si
LEFT JOIN users u ON si.completed_by = u.id
JOIN shopping_lists sl ON si.shopping_list_id = sl.id
WHERE sl.family_id = $1 AND sl.status = 'active'
ORDER BY si.created_at ASC;
```

### 5.7 商品完了（LIST-006）

#### 5.7.1 機能概要
子ユーザーが商品を「完了」状態に変更

#### 5.7.2 詳細動作フロー
```
1. 子ユーザーがリスト表示画面で未完了商品の完了ボタンをタップ
2. 商品の状態を「完了」に変更
3. shopping_itemsテーブルを更新
   - status: 'completed'
   - completed_by: ユーザーID
   - completed_at: 現在時刻
4. リアルタイム同期で他のデバイスに通知
5. リスト表示を更新（完了済み表示に変更）
```

### 5.8 進捗確認（LIST-007）

#### 5.8.1 機能概要
親ユーザーが完了/未完了の状況を確認

#### 5.8.2 表示仕様
- ホーム画面上部に進捗バーを表示
- 「完了 X / 全 Y 商品」形式で数値表示
- 進捗パーセンテージをプログレスバーで表示
- 完了済み商品は折りたたみ可能

---

## ⚡ 6. リアルタイム同期機能詳細

### 6.1 機能要件（PRD 3.2.4準拠）
| 機能ID | 機能名 | 詳細 |
|--------|--------|------|
| SYNC-001 | リアルタイム更新 | リスト変更の即座反映 |
| SYNC-002 | 状態同期 | 完了状態の即座共有 |

### 6.2 リアルタイム更新（SYNC-001）

#### 6.2.1 機能概要
お買い物リストの変更を5秒以内で他のデバイスに反映

#### 6.2.2 同期対象データ
- お買い物リストの作成・削除
- 商品の追加・編集・削除
- 商品の完了状態変更
- 家族メンバーの参加・離脱

#### 6.2.3 技術仕様
```dart
// Supabase Realtime 設定例
final subscription = supabase
  .channel('shopping_items')
  .onPostgresChanges(
    event: PostgresChangeEvent.all,
    schema: 'public',
    table: 'shopping_items',
    callback: (payload) {
      // リスト状態を更新
      updateShoppingList(payload);
    },
  )
  .subscribe();
```

#### 6.2.4 パフォーマンス要件
- 変更通知の遅延: 最大5秒以内（PRD準拠）
- 同時接続数: 最大100ユーザー（PRD準拠）
- データ整合性: eventual consistency

### 6.3 状態同期（SYNC-002）

#### 6.3.1 機能概要
商品完了状態の変更を即座に家族メンバー間で共有

#### 6.3.2 同期フロー
```
1. 子ユーザーが商品完了ボタンをタップ
2. ローカル状態を即座に更新（楽観的更新）
3. Supabaseに状態変更をPOST
4. Supabase Realtimeが他のクライアントに通知
5. 他のデバイスで状態を更新
6. エラー時はローカル状態をロールバック
```

#### 6.3.3 オフライン対応
- オフライン時は操作を無効化
- 接続復帰時に自動同期
- 競合解決はサーバー側データを優先

---

## 📱 7. 画面別詳細動作仕様

### 7.1 親用画面

#### 7.1.1 ログイン画面
**画面構成**:
- アプリロゴ
- 「Googleでログイン」ボタン
- ローディング表示

**操作フロー**:
1. 画面表示時に既存セッションをチェック
2. 有効なセッションがある場合はホーム画面へ自動遷移
3. 「Googleでログイン」ボタンタップでOAuth認証開始

#### 7.1.2 ホーム画面（リスト管理）
**画面構成**:
- QRコード表示エリア
- 進捗表示（完了 X / 全 Y 商品）
- お買い物リスト（商品一覧）
- 「商品追加」フローティングアクションボタン
- 家族メンバー表示エリア

**操作フロー**:
- リスト項目ロングタップ → 編集/削除メニュー
- 商品追加ボタン → 商品追加画面へ遷移
- QRコード長押し → QRコード拡大表示

#### 7.1.3 商品追加・編集画面
**画面構成**:
- 商品名入力フィールド
- 「保存」ボタン
- 「キャンセル」ボタン

**入力制限**:
- 商品名: 30文字以内
- リアルタイムバリデーション
- 重複チェック

### 7.2 子用画面

#### 7.2.1 ログイン画面
**画面構成**: 親用と同一

#### 7.2.2 QRコードスキャナー画面
**画面構成**:
- カメラプレビュー
- スキャンエリア枠表示
- 「QRコードを読み取ってください」説明文
- 手動入力リンク（将来拡張用）

**操作フロー**:
1. 画面表示時にカメラ権限を確認
2. 権限がない場合は権限要求ダイアログ表示
3. QRコード検出で自動的に家族参加処理

#### 7.2.3 リスト表示画面
**画面構成**:
- お買い物リスト（商品一覧）
- 各商品の完了ボタン
- 完了済み商品の表示切り替え
- 家族メンバー表示エリア

**操作フロー**:
- 完了ボタンタップ → 商品完了処理
- 完了済み商品の表示/非表示切り替え

---

## 🔧 8. エラーハンドリング仕様

### 8.1 エラー分類

#### 8.1.1 ネットワークエラー
**対象シナリオ**:
- インターネット接続なし
- Supabaseサーバーエラー
- タイムアウト

**対応方法**:
- ユーザーフレンドリーなエラーメッセージ表示
- リトライボタンの提供
- オフライン状態の明示

#### 8.1.2 認証エラー
**対象シナリオ**:
- 認証トークン期限切れ
- 無効なアクセス
- セッション無効化

**対応方法**:
- 自動的にログイン画面へ遷移
- 「再度ログインしてください」メッセージ表示

#### 8.1.3 バリデーションエラー
**対象シナリオ**:
- 入力内容不正
- 必須項目未入力
- 文字数制限違反

**対応方法**:
- 入力フィールド下にエラーメッセージ表示
- 該当フィールドの強調表示
- リアルタイムバリデーション

### 8.2 エラーメッセージ一覧

| エラー種類 | メッセージ | 表示場所 |
|-----------|-----------|---------|
| ネットワーク | 「インターネット接続を確認してください」 | スナックバー |
| 認証失敗 | 「ログインに失敗しました」 | ダイアログ |
| 入力必須 | 「{項目名}を入力してください」 | フィールド下 |
| 文字数制限 | 「{項目名}は{最大文字数}文字以内で入力してください」 | フィールド下 |
| 重複エラー | 「この{項目名}は既に存在します」 | フィールド下 |
| サーバーエラー | 「しばらく時間をおいて再度お試しください」 | ダイアログ |

---

## 🔄 9. 業務フロー詳細

### 9.1 初回利用フロー（親）
```
1. アプリ起動 → ログイン画面
2. 「Googleでログイン」 → Google OAuth認証
3. 認証成功 → 初回登録画面
4. 名前・役割（親）入力 → 登録完了
5. ホーム画面表示 → 家族グループ自動作成
6. QRコード自動生成・表示
7. 「新しいリスト作成」 → リスト作成
8. 商品追加開始
```

### 9.2 初回利用フロー（子）
```
1. アプリ起動 → ログイン画面
2. 「Googleでログイン」 → Google OAuth認証
3. 認証成功 → 初回登録画面
4. 名前・役割（子）入力 → 登録完了
5. QRコードスキャナー画面表示
6. 親のQRコードスキャン → 家族参加完了
7. リスト表示画面へ遷移
8. お買い物開始
```

### 9.3 日常利用フロー
```
1. アプリ起動 → セッション確認
2. 有効な場合は各役割のホーム画面へ直接遷移
3. 親: リスト管理・進捗確認
4. 子: リスト確認・商品完了
5. リアルタイム同期で状態共有
```

---

## 🔌 10. API仕様概要

### 10.1 Supabase API エンドポイント

#### 10.1.1 認証関連
- `POST /auth/v1/token` - Google OAuth認証
- `POST /auth/v1/logout` - ログアウト
- `GET /auth/v1/user` - ユーザー情報取得

#### 10.1.2 ユーザー管理
- `POST /rest/v1/users` - ユーザー作成
- `GET /rest/v1/users` - ユーザー情報取得
- `PATCH /rest/v1/users` - ユーザー情報更新

#### 10.1.3 家族管理
- `POST /rest/v1/families` - 家族グループ作成
- `POST /rest/v1/family_members` - 家族参加
- `GET /rest/v1/family_members` - 家族メンバー取得

#### 10.1.4 お買い物リスト管理
- `POST /rest/v1/shopping_lists` - リスト作成
- `GET /rest/v1/shopping_lists` - リスト取得
- `POST /rest/v1/shopping_items` - 商品追加
- `PATCH /rest/v1/shopping_items` - 商品更新
- `DELETE /rest/v1/shopping_items` - 商品削除

### 10.2 Row Level Security (RLS) ポリシー概要

#### 10.2.1 基本方針
- 各ユーザーは自分の家族グループのデータのみアクセス可能
- 認証されたユーザーのみがデータアクセス可能
- 親は全データの作成・更新・削除が可能
- 子は商品の完了状態変更のみ可能

#### 10.2.2 主要ポリシー例
```sql
-- shopping_items テーブルのRLSポリシー例
CREATE POLICY "Users can view family shopping items" ON shopping_items
FOR SELECT TO authenticated
USING (
  shopping_list_id IN (
    SELECT sl.id FROM shopping_lists sl
    JOIN family_members fm ON sl.family_id = fm.family_id
    WHERE fm.user_id = auth.uid()
  )
);
```

---

## 📊 11. パフォーマンス・拡張性要件詳細

### 11.1 応答時間要件（PRD準拠）
| 操作 | 目標時間 | 測定方法 |
|------|---------|---------|
| アプリ起動 | 3秒以内 | 冷起動からホーム画面表示まで |
| 画面遷移 | 300ms以内 | タップから画面表示まで |
| リアルタイム同期 | 5秒以内 | 変更から他デバイス反映まで |
| API レスポンス | 2秒以内 | リクエスト送信からレスポンス受信まで |

### 11.2 データ量要件
- 商品名最大長: 30文字
- リスト名最大長: 50文字
- 家族グループあたり最大商品数: 100件
- 同時アクティブリスト数: 1件

### 11.3 メモリ使用量要件
- アプリ最大メモリ使用量: 128MB
- QRコード画像キャッシュ: 最大10MB
- リアルタイム接続維持: 常時接続

### 11.4 拡張性要件（PRD 6.5/8.1準拠）
| 指標 | 目標値 | 測定方法 |
|------|--------|---------|
| **新機能追加時の既存コード変更率** | 20%以下 | 新機能追加時のコード変更行数 / 全体行数 |
| **コード削減率** | 64%削減（前回プロジェクト比） | 総コード行数の比較測定 |
| **モジュール独立性** | 依存関係5個以下/モジュール | モジュール間import分析 |
| **API後方互換性** | 100%維持 | 既存API仕様変更なし |

### 11.5 拡張性実装指針
- **機能別パッケージ化**: 認証、QRコード、リスト管理を独立パッケージ化
- **インターフェース設計**: 各機能のインターフェースを明確に定義
- **依存性注入**: Riverpodを活用した疎結合設計
- **設定駆動**: 機能ON/OFF、パラメータ調整を設定ファイルで制御

---

## 🔒 12. セキュリティ仕様詳細

### 12.1 データ保護
- 全通信のHTTPS化
- Supabase Row Level Security適用
- Google OAuth 2.0による認証
- JWTトークンによるセッション管理

### 12.2 権限制御
- 親: 全操作権限（作成・読取・更新・削除）
- 子: 読取・商品完了操作のみ
- 家族グループ外のデータアクセス禁止

### 12.3 個人情報取り扱い
- 最小限のデータ収集（名前・役割のみ）
- Googleアカウント情報の適切な管理
- ユーザー削除時のデータ完全削除

---

## 📝 13. 承認・変更管理

### 13.1 承認フロー
1. **PDM作成** → **全エンジニア系職種レビュー** → **チームリーダー承認**
2. **承認者**: 全エンジニア系職種 + チームリーダー
3. **承認基準**: 技術的実現可能性・実装詳細度・保守性の確認

### 13.2 変更管理
- **軽微な変更**: PDMが判断・実行
- **仕様変更**: エンジニア系職種の合意必須
- **アーキテクチャ変更**: チームリーダー承認必須

---

## 📞 14. 参考資料・連絡先

### 14.1 関連文書
- プロダクト要求仕様書 (PRD) v1.0
- プロジェクト開発資料チェックリスト
- システムアーキテクチャ設計書（作成予定）

### 14.2 技術参考資料
- [Flutter公式ドキュメント](https://docs.flutter.dev/)
- [Supabase公式ドキュメント](https://supabase.com/docs)
- [Riverpod公式ドキュメント](https://riverpod.dev/)
- [Google OAuth 2.0](https://developers.google.com/identity/protocols/oauth2)

---

### 14.3 更新履歴
- **v1.0** (2025年09月21日): 初版作成
- **v1.1** (2025年09月22日): 拡張性要件・モジュラー設計追加、コード削減率64%反映

---

**文書作成者**: PDM (ベテランプロダクトマネージャー)  
**最終確認**: 2025年09月22日  
**次回レビュー予定**: エンジニア系職種レビュー後