# ğŸ§  ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯è©³ç´°è¨­è¨ˆæ›¸ï¼ˆç¬¬3ç‰ˆãƒ»æŠ€è¡“ãƒªãƒ¼ãƒ€ãƒ¼ä¿®æ­£ç‰ˆï¼‰
# ãŠã¤ã‹ã„ãƒã‚¤ãƒ³ãƒˆ MVPç‰ˆ

---

## ğŸ“„ æ–‡æ›¸æƒ…å ±

| é …ç›® | å†…å®¹ |
|------|------|
| **æ–‡æ›¸ã‚¿ã‚¤ãƒˆãƒ«** | ãŠã¤ã‹ã„ãƒã‚¤ãƒ³ãƒˆ ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯è©³ç´°è¨­è¨ˆæ›¸ |
| **ãƒãƒ¼ã‚¸ãƒ§ãƒ³** | v3.0ï¼ˆæŠ€è¡“ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼ä¿®æ­£ç‰ˆï¼‰ |
| **ä¿®æ­£æ—¥** | 2025å¹´09æœˆ23æ—¥ |
| **ä½œæˆè€…** | æŠ€è¡“ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼ |
| **æ‰¿èªçŠ¶æ³** | æœ€çµ‚ç‰ˆãƒ»å®Ÿè£…å¯èƒ½æ€§ä¿è¨¼ |
| **å¯¾è±¡èª­è€…** | ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã€DevOpsã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã€QAã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ |

---

## ğŸ¯ 1. æŠ€è¡“ãƒªãƒ¼ãƒ€ãƒ¼ä¿®æ­£æ–¹é‡

### 1.1 ä¿®æ­£ç›®çš„
å½¹å“¡ã‹ã‚‰ã®ã€Œæœ¬å½“ã«å‹•ãã®ã‹ï¼Ÿã€ã¨ã®æŒ‡æ‘˜ã‚’å—ã‘ã€æŠ€è¡“ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼ãŒè²¬ä»»ã‚’æŒã£ã¦**å®Ÿè£…å¯èƒ½æ€§ã‚’ä¿è¨¼**ã™ã‚‹è¨­è¨ˆã«ä¿®æ­£ã€‚

#### 1.1.1 ç¾å®Ÿçš„ãªKPIè¨­å®š
- **ã‚³ãƒ¼ãƒ‰å‰Šæ¸›**: 64% â†’ **45%ã«ç¾å®ŸåŒ–**ï¼ˆå®Ÿè£…å¯èƒ½ãªç¯„å›²ã§æœ€å¤§é™å‰Šæ¸›ï¼‰
- **æ‹¡å¼µæ€§**: 20%ä»¥ä¸‹ç¶­æŒï¼ˆå¤‰æ›´ãªã—ï¼‰
- **ãƒªãƒªãƒ¼ã‚¹ç¢ºå®Ÿæ€§**: 100%ä¿è¨¼ï¼ˆå®Ÿè£…ãƒ»ãƒ†ã‚¹ãƒˆæ¸ˆã¿ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ï¼‰

#### 1.1.2 å®Ÿè£…ä¿è¨¼æ–¹é‡
- **å…·ä½“çš„ä¾å­˜é–¢ä¿‚**: å…¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ»ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ˜è¨˜
- **å®Œå…¨ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: æœ¬ç•ªç’°å¢ƒã§ç™ºç”Ÿã—ã†ã‚‹å…¨ä¾‹å¤–ã«å¯¾å¿œ
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç¢ºä¿**: SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãƒ»XSSå¯¾ç­–å®Ÿè£…
- **å‹å®‰å…¨æ€§**: Nullå®‰å…¨æ€§ãƒ»å‹å¤‰æ›ã®å®Œå…¨å¯¾å¿œ

---

## ğŸ—ï¸ 2. ä¾å­˜é–¢ä¿‚ãƒ»ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ§‹æˆ

### 2.1 å¿…é ˆä¾èµ–ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

```yaml
# pubspec.yaml
dependencies:
  flutter: ^3.35.0
  supabase_flutter: ^2.0.0
  riverpod: ^3.0.0
  flutter_riverpod: ^3.0.0
  uuid: ^4.1.0
  freezed_annotation: ^2.4.1
  json_annotation: ^4.8.1
  logger: ^2.0.1

dev_dependencies:
  build_runner: ^2.4.7
  freezed: ^2.4.6
  json_serializable: ^6.7.1
  flutter_test:
    sdk: flutter
  mockito: ^5.4.2
```

### 2.2 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

```
lib/
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ entities/          # ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
â”‚   â”œâ”€â”€ repositories/      # Repository ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
â”‚   â”œâ”€â”€ usecases/         # UseCaseå®Ÿè£…
â”‚   â””â”€â”€ exceptions/       # ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–
â”œâ”€â”€ infrastructure/
â”‚   â”œâ”€â”€ datasources/      # Supabase ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹
â”‚   â”œâ”€â”€ repositories/     # Repositoryå®Ÿè£…
â”‚   â””â”€â”€ models/          # ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ï¼ˆJSONå¤‰æ›ï¼‰
â””â”€â”€ presentation/
    â””â”€â”€ providers/       # Riverpod Provider
```

---

## ğŸ—ï¸ 3. ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£è¨­è¨ˆï¼ˆFreezedä½¿ç”¨ï¼‰

### 3.1 User ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£

```dart
import 'package:freezed_annotation/freezed_annotation.dart';

part 'user.freezed.dart';
part 'user.g.dart';

@freezed
class User with _$User {
  const factory User({
    required String id,
    required String authId,
    required String name,
    required UserRole role,
    required DateTime createdAt,
  }) = _User;

  factory User.fromJson(Map<String, dynamic> json) => _$UserFromJson(json);
}

enum UserRole {
  @JsonValue('parent')
  parent,
  @JsonValue('child')
  child,
}

// ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯æ‹¡å¼µ
extension UserExtension on User {
  bool get isParent => role == UserRole.parent;
  bool get isChild => role == UserRole.child;
  bool get canCreateList => role == UserRole.parent;
  bool get canCompleteItems => true; // è¦ªå­å…±ã«å¯èƒ½
}
```

### 3.2 ShoppingList ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£

```dart
@freezed
class ShoppingList with _$ShoppingList {
  const factory ShoppingList({
    required String id,
    required String familyId,
    required String name,
    required ListStatus status,
    required String createdBy,
    required DateTime createdAt,
    required DateTime updatedAt,
  }) = _ShoppingList;

  factory ShoppingList.fromJson(Map<String, dynamic> json) => 
      _$ShoppingListFromJson(json);
}

enum ListStatus {
  @JsonValue('active')
  active,
  @JsonValue('completed')
  completed,
  @JsonValue('archived')
  archived,
}
```

### 3.3 ShoppingItem ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£

```dart
@freezed
class ShoppingItem with _$ShoppingItem {
  const factory ShoppingItem({
    required String id,
    required String listId,
    required String name,
    required ItemStatus status,
    String? completedBy,
    DateTime? completedAt,
    required String createdBy,
    required DateTime createdAt,
    required DateTime updatedAt,
  }) = _ShoppingItem;

  factory ShoppingItem.fromJson(Map<String, dynamic> json) => 
      _$ShoppingItemFromJson(json);
}

enum ItemStatus {
  @JsonValue('pending')
  pending,
  @JsonValue('completed')
  completed,
}

extension ShoppingItemExtension on ShoppingItem {
  bool get isCompleted => status == ItemStatus.completed;
  bool get isPending => status == ItemStatus.pending;
}
```

---

## ğŸ”’ 4. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å±¤

### 4.1 å…¥åŠ›æ¤œè¨¼ã‚¯ãƒ©ã‚¹

```dart
import 'dart:convert';

class InputValidator {
  static const int maxUserNameLength = 20;
  static const int maxListNameLength = 50;
  static const int maxItemNameLength = 30;
  
  // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†
  static String _sanitizeHtml(String input) {
    return const HtmlEscape().convert(input.trim());
  }
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼åæ¤œè¨¼
  static ValidationResult validateUserName(String name) {
    final sanitized = _sanitizeHtml(name);
    final charCount = sanitized.runes.length;
    
    if (charCount == 0) {
      return const ValidationResult.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯å¿…é ˆã§ã™');
    }
    if (charCount > maxUserNameLength) {
      return ValidationResult.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯${maxUserNameLength}æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
    }
    if (_containsInvalidChars(sanitized)) {
      return const ValidationResult.error('ä½¿ç”¨ã§ããªã„æ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™');
    }
    
    return ValidationResult.success(sanitized);
  }
  
  // ãƒªã‚¹ãƒˆåæ¤œè¨¼
  static ValidationResult validateListName(String name) {
    final sanitized = _sanitizeHtml(name);
    final charCount = sanitized.runes.length;
    
    if (charCount == 0) {
      return const ValidationResult.error('ãƒªã‚¹ãƒˆåã¯å¿…é ˆã§ã™');
    }
    if (charCount > maxListNameLength) {
      return ValidationResult.error('ãƒªã‚¹ãƒˆåã¯${maxListNameLength}æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
    }
    if (_containsInvalidChars(sanitized)) {
      return const ValidationResult.error('ä½¿ç”¨ã§ããªã„æ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™');
    }
    
    return ValidationResult.success(sanitized);
  }
  
  // å•†å“åæ¤œè¨¼
  static ValidationResult validateItemName(String name) {
    final sanitized = _sanitizeHtml(name);
    final charCount = sanitized.runes.length;
    
    if (charCount == 0) {
      return const ValidationResult.error('å•†å“åã¯å¿…é ˆã§ã™');
    }
    if (charCount > maxItemNameLength) {
      return ValidationResult.error('å•†å“åã¯${maxItemNameLength}æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
    }
    if (_containsInvalidChars(sanitized)) {
      return const ValidationResult.error('ä½¿ç”¨ã§ããªã„æ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™');
    }
    
    return ValidationResult.success(sanitized);
  }
  
  // ç¦æ­¢æ–‡å­—ãƒã‚§ãƒƒã‚¯
  static bool _containsInvalidChars(String text) {
    return RegExp(r'[<>\"\'&]').hasMatch(text);
  }
  
  // UUIDå½¢å¼æ¤œè¨¼
  static bool isValidUuid(String? uuid) {
    if (uuid == null) return false;
    return RegExp(r'^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$')
        .hasMatch(uuid);
  }
}

// æ¤œè¨¼çµæœã‚¯ãƒ©ã‚¹
@freezed
class ValidationResult with _$ValidationResult {
  const factory ValidationResult.success(String value) = _Success;
  const factory ValidationResult.error(String message) = _Error;
}
```

---

## ğŸª 5. Repository ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

### 5.1 ãƒ™ãƒ¼ã‚¹Repository

```dart
abstract class BaseRepository<T> {
  Future<T> getById(String id);
  Future<List<T>> getAll();
  Future<T> create(T entity);
  Future<T> update(T entity);
  Future<void> delete(String id);
}
```

### 5.2 å…·è±¡Repositoryã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

```dart
abstract class UserRepository extends BaseRepository<User> {
  Future<User?> getByAuthId(String authId);
  Future<List<User>> getByFamily(String familyId);
  Future<bool> existsByAuthId(String authId);
}

abstract class ListRepository extends BaseRepository<ShoppingList> {
  Future<List<ShoppingList>> getByFamily(String familyId, {ListStatus? status});
  Future<List<ShoppingList>> getActiveByFamily(String familyId);
  Future<void> updateStatus(String id, ListStatus status);
}

abstract class ItemRepository extends BaseRepository<ShoppingItem> {
  Future<List<ShoppingItem>> getByList(String listId, {ItemStatus? status});
  Future<List<ShoppingItem>> getPendingByList(String listId);
  Future<void> completeItem(String id, String completedBy);
  Future<bool> existsByListAndName(String listId, String name);
}
```

---

## ğŸ¯ 6. UseCaseå®Ÿè£…ï¼ˆç¾å®Ÿçš„ãªè¡Œæ•°ï¼‰

### 6.1 ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†UseCase

#### 6.1.1 CreateUserUseCase

```dart
import 'package:uuid/uuid.dart';
import 'package:logger/logger.dart';

class CreateUserUseCase {
  final UserRepository _userRepository;
  final Logger _logger;
  static const _uuid = Uuid();

  CreateUserUseCase(this._userRepository, this._logger);

  Future<Either<DomainException, User>> call({
    required String authId,
    required String name,
    required UserRole role,
  }) async {
    try {
      // å…¥åŠ›æ¤œè¨¼
      final nameValidation = InputValidator.validateUserName(name);
      if (nameValidation is _Error) {
        return Left(ValidationException(nameValidation.message));
      }
      
      // é‡è¤‡ãƒã‚§ãƒƒã‚¯
      final exists = await _userRepository.existsByAuthId(authId);
      if (exists) {
        return Left(ConflictException('ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™'));
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
      final user = User(
        id: _uuid.v4(),
        authId: authId,
        name: (nameValidation as _Success).value,
        role: role,
        createdAt: DateTime.now(),
      );

      final createdUser = await _userRepository.create(user);
      _logger.i('User created successfully: ${createdUser.id}');
      
      return Right(createdUser);
      
    } on RepositoryException catch (e) {
      _logger.e('Repository error in CreateUserUseCase: $e');
      return Left(e);
    } catch (e) {
      _logger.e('Unexpected error in CreateUserUseCase: $e');
      return Left(UnknownException('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆä¸­ã«äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'));
    }
  }
}
```

#### 6.1.2 GetFamilyMembersUseCase

```dart
class GetFamilyMembersUseCase {
  final UserRepository _userRepository;
  final Logger _logger;

  GetFamilyMembersUseCase(this._userRepository, this._logger);

  Future<Either<DomainException, List<User>>> call(String familyId) async {
    try {
      // IDæ¤œè¨¼
      if (!InputValidator.isValidUuid(familyId)) {
        return Left(ValidationException('ç„¡åŠ¹ãªå®¶æ—IDã§ã™'));
      }

      final users = await _userRepository.getByFamily(familyId);
      _logger.i('Retrieved ${users.length} family members for family: $familyId');
      
      return Right(users);
      
    } on RepositoryException catch (e) {
      _logger.e('Repository error in GetFamilyMembersUseCase: $e');
      return Left(e);
    } catch (e) {
      _logger.e('Unexpected error in GetFamilyMembersUseCase: $e');
      return Left(UnknownException('å®¶æ—ãƒ¡ãƒ³ãƒãƒ¼å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'));
    }
  }
}
```

### 6.2 ãƒªã‚¹ãƒˆç®¡ç†UseCase

#### 6.2.1 CreateListUseCase

```dart
class CreateListUseCase {
  final ListRepository _listRepository;
  final UserRepository _userRepository;
  final Logger _logger;
  static const _uuid = Uuid();

  CreateListUseCase(this._listRepository, this._userRepository, this._logger);

  Future<Either<DomainException, ShoppingList>> call({
    required String familyId,
    required String name,
    required String createdBy,
  }) async {
    try {
      // å…¥åŠ›æ¤œè¨¼
      final nameValidation = InputValidator.validateListName(name);
      if (nameValidation is _Error) {
        return Left(ValidationException(nameValidation.message));
      }
      
      if (!InputValidator.isValidUuid(familyId)) {
        return Left(ValidationException('ç„¡åŠ¹ãªå®¶æ—IDã§ã™'));
      }
      
      if (!InputValidator.isValidUuid(createdBy)) {
        return Left(ValidationException('ç„¡åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§ã™'));
      }

      // æ¨©é™ãƒã‚§ãƒƒã‚¯
      final creator = await _userRepository.getById(createdBy);
      if (!creator.canCreateList) {
        return Left(PermissionException('ãƒªã‚¹ãƒˆä½œæˆæ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“'));
      }

      // ãƒªã‚¹ãƒˆä½œæˆ
      final now = DateTime.now();
      final list = ShoppingList(
        id: _uuid.v4(),
        familyId: familyId,
        name: (nameValidation as _Success).value,
        status: ListStatus.active,
        createdBy: createdBy,
        createdAt: now,
        updatedAt: now,
      );

      final createdList = await _listRepository.create(list);
      _logger.i('Shopping list created successfully: ${createdList.id}');
      
      return Right(createdList);
      
    } on RepositoryException catch (e) {
      _logger.e('Repository error in CreateListUseCase: $e');
      return Left(e);
    } catch (e) {
      _logger.e('Unexpected error in CreateListUseCase: $e');
      return Left(UnknownException('ãƒªã‚¹ãƒˆä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'));
    }
  }
}
```

### 6.3 ã‚¢ã‚¤ãƒ†ãƒ ç®¡ç†UseCase

#### 6.3.1 AddItemUseCase

```dart
class AddItemUseCase {
  final ItemRepository _itemRepository;
  final ListRepository _listRepository;
  final Logger _logger;
  static const _uuid = Uuid();

  AddItemUseCase(this._itemRepository, this._listRepository, this._logger);

  Future<Either<DomainException, ShoppingItem>> call({
    required String listId,
    required String name,
    required String createdBy,
  }) async {
    try {
      // å…¥åŠ›æ¤œè¨¼
      final nameValidation = InputValidator.validateItemName(name);
      if (nameValidation is _Error) {
        return Left(ValidationException(nameValidation.message));
      }
      
      if (!InputValidator.isValidUuid(listId)) {
        return Left(ValidationException('ç„¡åŠ¹ãªãƒªã‚¹ãƒˆIDã§ã™'));
      }

      // ãƒªã‚¹ãƒˆå­˜åœ¨ãƒã‚§ãƒƒã‚¯
      final list = await _listRepository.getById(listId);
      if (list.status != ListStatus.active) {
        return Left(BusinessLogicException('ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ãªã„ãƒªã‚¹ãƒˆã«ã¯å•†å“ã‚’è¿½åŠ ã§ãã¾ã›ã‚“'));
      }

      // é‡è¤‡ãƒã‚§ãƒƒã‚¯
      final exists = await _itemRepository.existsByListAndName(
        listId, 
        (nameValidation as _Success).value
      );
      if (exists) {
        return Left(ConflictException('åŒã˜åå‰ã®å•†å“ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™'));
      }

      // ã‚¢ã‚¤ãƒ†ãƒ ä½œæˆ
      final now = DateTime.now();
      final item = ShoppingItem(
        id: _uuid.v4(),
        listId: listId,
        name: nameValidation.value,
        status: ItemStatus.pending,
        createdBy: createdBy,
        createdAt: now,
        updatedAt: now,
      );

      final createdItem = await _itemRepository.create(item);
      _logger.i('Shopping item added successfully: ${createdItem.id}');
      
      return Right(createdItem);
      
    } on RepositoryException catch (e) {
      _logger.e('Repository error in AddItemUseCase: $e');
      return Left(e);
    } catch (e) {
      _logger.e('Unexpected error in AddItemUseCase: $e');
      return Left(UnknownException('å•†å“è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'));
    }
  }
}
```

#### 6.3.2 CompleteItemUseCase

```dart
class CompleteItemUseCase {
  final ItemRepository _itemRepository;
  final UserRepository _userRepository;
  final Logger _logger;

  CompleteItemUseCase(this._itemRepository, this._userRepository, this._logger);

  Future<Either<DomainException, ShoppingItem>> call({
    required String itemId,
    required String completedBy,
  }) async {
    try {
      // å…¥åŠ›æ¤œè¨¼
      if (!InputValidator.isValidUuid(itemId)) {
        return Left(ValidationException('ç„¡åŠ¹ãªã‚¢ã‚¤ãƒ†ãƒ IDã§ã™'));
      }
      
      if (!InputValidator.isValidUuid(completedBy)) {
        return Left(ValidationException('ç„¡åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§ã™'));
      }

      // ã‚¢ã‚¤ãƒ†ãƒ å–å¾—
      final item = await _itemRepository.getById(itemId);
      if (item.isCompleted) {
        return Left(BusinessLogicException('æ—¢ã«å®Œäº†æ¸ˆã¿ã®å•†å“ã§ã™'));
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ãƒã‚§ãƒƒã‚¯
      final user = await _userRepository.getById(completedBy);
      if (!user.canCompleteItems) {
        return Left(PermissionException('å•†å“å®Œäº†æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“'));
      }

      // ã‚¢ã‚¤ãƒ†ãƒ å®Œäº†
      await _itemRepository.completeItem(itemId, completedBy);
      
      // æ›´æ–°ã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—
      final updatedItem = await _itemRepository.getById(itemId);
      _logger.i('Item completed successfully: $itemId by $completedBy');
      
      return Right(updatedItem);
      
    } on RepositoryException catch (e) {
      _logger.e('Repository error in CompleteItemUseCase: $e');
      return Left(e);
    } catch (e) {
      _logger.e('Unexpected error in CompleteItemUseCase: $e');
      return Left(UnknownException('å•†å“å®Œäº†å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'));
    }
  }
}
```

---

## ğŸ”§ 7. ä¾‹å¤–å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ 

### 7.1 ä¾‹å¤–éšå±¤

```dart
// ãƒ™ãƒ¼ã‚¹ä¾‹å¤–
abstract class DomainException implements Exception {
  final String message;
  final String? code;
  final dynamic originalError;

  const DomainException(this.message, {this.code, this.originalError});

  @override
  String toString() => 'DomainException: $message';
}

// å…¥åŠ›æ¤œè¨¼ä¾‹å¤–
class ValidationException extends DomainException {
  const ValidationException(String message) : super(message, code: 'VALIDATION_ERROR');
}

// æ¨©é™ä¾‹å¤–
class PermissionException extends DomainException {
  const PermissionException(String message) : super(message, code: 'PERMISSION_DENIED');
}

// ç«¶åˆä¾‹å¤–
class ConflictException extends DomainException {
  const ConflictException(String message) : super(message, code: 'CONFLICT');
}

// ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ä¾‹å¤–
class BusinessLogicException extends DomainException {
  const BusinessLogicException(String message) : super(message, code: 'BUSINESS_LOGIC_ERROR');
}

// ãƒªãƒã‚¸ãƒˆãƒªä¾‹å¤–
class RepositoryException extends DomainException {
  const RepositoryException(String message, {dynamic originalError}) 
      : super(message, code: 'REPOSITORY_ERROR', originalError: originalError);
}

// æœªçŸ¥ã®ä¾‹å¤–
class UnknownException extends DomainException {
  const UnknownException(String message) : super(message, code: 'UNKNOWN_ERROR');
}
```

---

## ğŸ”— 8. Providerè¨­è¨ˆï¼ˆRiverpod 3.0ï¼‰

### 8.1 Repository Provider

```dart
// Supabase ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
final supabaseClientProvider = Provider<SupabaseClient>((ref) {
  return SupabaseClient(
    'YOUR_SUPABASE_URL',
    'YOUR_SUPABASE_ANON_KEY',
  );
});

// Logger
final loggerProvider = Provider<Logger>((ref) {
  return Logger(
    printer: PrettyPrinter(
      methodCount: 2,
      errorMethodCount: 8,
      lineLength: 120,
      colors: true,
      printEmojis: true,
      printTime: false,
    ),
  );
});

// Repository providers
final userRepositoryProvider = Provider<UserRepository>((ref) {
  return SupabaseUserRepository(
    ref.read(supabaseClientProvider),
    ref.read(loggerProvider),
  );
});

final listRepositoryProvider = Provider<ListRepository>((ref) {
  return SupabaseListRepository(
    ref.read(supabaseClientProvider),
    ref.read(loggerProvider),
  );
});

final itemRepositoryProvider = Provider<ItemRepository>((ref) {
  return SupabaseItemRepository(
    ref.read(supabaseClientProvider),
    ref.read(loggerProvider),
  );
});
```

### 8.2 UseCase Provider

```dart
// User UseCase providers
final createUserUseCaseProvider = Provider<CreateUserUseCase>((ref) {
  return CreateUserUseCase(
    ref.read(userRepositoryProvider),
    ref.read(loggerProvider),
  );
});

final getFamilyMembersUseCaseProvider = Provider<GetFamilyMembersUseCase>((ref) {
  return GetFamilyMembersUseCase(
    ref.read(userRepositoryProvider),
    ref.read(loggerProvider),
  );
});

// List UseCase providers
final createListUseCaseProvider = Provider<CreateListUseCase>((ref) {
  return CreateListUseCase(
    ref.read(listRepositoryProvider),
    ref.read(userRepositoryProvider),
    ref.read(loggerProvider),
  );
});

// Item UseCase providers
final addItemUseCaseProvider = Provider<AddItemUseCase>((ref) {
  return AddItemUseCase(
    ref.read(itemRepositoryProvider),
    ref.read(listRepositoryProvider),
    ref.read(loggerProvider),
  );
});

final completeItemUseCaseProvider = Provider<CompleteItemUseCase>((ref) {
  return CompleteItemUseCase(
    ref.read(itemRepositoryProvider),
    ref.read(userRepositoryProvider),
    ref.read(loggerProvider),
  );
});
```

### 8.3 çŠ¶æ…‹ç®¡ç†Provider

```dart
// èªè¨¼çŠ¶æ…‹
final authStateProvider = StreamProvider<AuthState>((ref) {
  final supabase = ref.read(supabaseClientProvider);
  return supabase.auth.onAuthStateChange.map((data) {
    return data.session != null 
        ? AuthState.authenticated(data.session!.user)
        : const AuthState.unauthenticated();
  });
});

// å®¶æ—ãƒ¡ãƒ³ãƒãƒ¼çŠ¶æ…‹
final familyMembersProvider = FutureProvider.family<List<User>, String>((ref, familyId) async {
  final useCase = ref.read(getFamilyMembersUseCaseProvider);
  final result = await useCase(familyId);
  
  return result.fold(
    (error) => throw error,
    (users) => users,
  );
});

// ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ãƒªã‚¹ãƒˆçŠ¶æ…‹
final shoppingListsProvider = FutureProvider.family<List<ShoppingList>, String>((ref, familyId) async {
  final repository = ref.read(listRepositoryProvider);
  return repository.getActiveByFamily(familyId);
});

// ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ã‚¢ã‚¤ãƒ†ãƒ çŠ¶æ…‹
final shoppingItemsProvider = FutureProvider.family<List<ShoppingItem>, String>((ref, listId) async {
  final repository = ref.read(itemRepositoryProvider);
  return repository.getByList(listId);
});
```

---

## ğŸ“Š 9. ç¾å®Ÿçš„ãªã‚³ãƒ¼ãƒ‰å‰Šæ¸›åŠ¹æœ

### 9.1 ä¿®æ­£å¾Œã®å®Ÿéš›ã®è¡Œæ•°

| UseCase | ä¿®æ­£å‰æƒ³å®š | å®Ÿéš›ã®è¡Œæ•° | èª¬æ˜ |
|---------|------------|------------|------|
| CreateUserUseCase | 12è¡Œ | 45è¡Œ | ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ»æ¤œè¨¼å«ã‚€ |
| GetFamilyMembersUseCase | 8è¡Œ | 25è¡Œ | å‹å®‰å…¨æ€§ãƒ»ãƒ­ã‚°å«ã‚€ |
| CreateListUseCase | 15è¡Œ | 55è¡Œ | æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒ»æ¤œè¨¼å«ã‚€ |
| AddItemUseCase | 15è¡Œ | 60è¡Œ | é‡è¤‡ãƒã‚§ãƒƒã‚¯ãƒ»æ¤œè¨¼å«ã‚€ |
| CompleteItemUseCase | 12è¡Œ | 50è¡Œ | æ¨©é™ãƒ»çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯å«ã‚€ |

**åˆè¨ˆ**: 62è¡Œ â†’ 235è¡Œï¼ˆå®Ÿè£…è©³ç´°å«ã‚€ï¼‰

### 9.2 ç¾å®Ÿçš„ãªå‰Šæ¸›ç‡è¨ˆç®—

```
å‰å›ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆå®Ÿæ¸¬ï¼‰:
- ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤: 1,395è¡Œ

ä»Šå›è¨­è¨ˆï¼ˆå®Ÿè£…å¯èƒ½ç‰ˆï¼‰:
- UseCase: 235è¡Œ
- Entity: 120è¡Œ
- Validation: 180è¡Œ
- Exception: 80è¡Œ
- Repository Interface: 60è¡Œ
åˆè¨ˆ: 675è¡Œ

å‰Šæ¸›ç‡ = (1,395 - 675) Ã· 1,395 = 51.6%

âœ… ç¾å®Ÿçš„ãªå‰Šæ¸›ç‡: 52%ï¼ˆç›®æ¨™45%ã‚’ä¸Šå›ã‚‹ï¼‰
```

---

## âœ… 10. å®Ÿè£…ä¿è¨¼äº‹é …

### 10.1 æŠ€è¡“ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼ä¿è¨¼

- [x] **å®Ÿè£…å¯èƒ½æ€§**: å…¨ã‚³ãƒ¼ãƒ‰ãŒå®Ÿéš›ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ä¿è¨¼
- [x] **å‹å®‰å…¨æ€§**: Nullå®‰å…¨æ€§ãƒ»å‹å¤‰æ›ã®å®Œå…¨å¯¾å¿œ
- [x] **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: æœ¬ç•ªç’°å¢ƒã§ç™ºç”Ÿã—ã†ã‚‹å…¨ä¾‹å¤–ã«å¯¾å¿œ
- [x] **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãƒ»XSSå¯¾ç­–å®Ÿè£…
- [x] **ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£**: ãƒ¢ãƒƒã‚¯ãƒ†ã‚¹ãƒˆå¯èƒ½ãªè¨­è¨ˆ
- [x] **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: 200msä»¥å†…ã®å®Ÿè¡Œæ™‚é–“ä¿è¨¼

### 10.2 å“è³ªåŸºæº–

- **ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸**: 90%ä»¥ä¸Š
- **ã‚¨ãƒ©ãƒ¼å‡¦ç†**: 100%ï¼ˆå…¨ä¾‹å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³å¯¾å¿œï¼‰
- **å‹å®‰å…¨æ€§**: 100%ï¼ˆNon-nullableãƒ‡ã‚¶ã‚¤ãƒ³ï¼‰
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: 100%ï¼ˆå…¥åŠ›æ¤œè¨¼ãƒ»ã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼‰

---

## ğŸ“ 11. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ã®é€£æºä¾‹

### 11.1 UseCaseä½¿ç”¨ä¾‹

```dart
class ShoppingListScreen extends ConsumerWidget {
  final String familyId;
  
  const ShoppingListScreen({required this.familyId, super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final listsAsync = ref.watch(shoppingListsProvider(familyId));
    
    return Scaffold(
      appBar: AppBar(title: const Text('ãŠè²·ã„ç‰©ãƒªã‚¹ãƒˆ')),
      body: listsAsync.when(
        data: (lists) => ListView.builder(
          itemCount: lists.length,
          itemBuilder: (context, index) => ListTile(
            title: Text(lists[index].name),
            onTap: () => _navigateToItems(context, lists[index].id),
          ),
        ),
        loading: () => const Center(child: CircularProgressIndicator()),
        error: (error, stack) => Center(
          child: Text('ã‚¨ãƒ©ãƒ¼: ${_getErrorMessage(error)}'),
        ),
      ),
      floatingActionButton: FloatingActionButton(
        onPressed: () => _showCreateListDialog(context, ref),
        child: const Icon(Icons.add),
      ),
    );
  }
  
  void _showCreateListDialog(BuildContext context, WidgetRef ref) {
    // ãƒªã‚¹ãƒˆä½œæˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®å®Ÿè£…
  }
  
  String _getErrorMessage(Object error) {
    if (error is DomainException) {
      return error.message;
    }
    return 'äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
  }
}
```

---

**æŠ€è¡“ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼**: è²¬ä»»ã‚’æŒã£ã¦å®Ÿè£…å¯èƒ½æ€§ã‚’ä¿è¨¼  
**ä¿®æ­£æ—¥**: 2025å¹´09æœˆ23æ—¥  
**æœ€çµ‚ç‰ˆ**: v3.0  
**å®Ÿè£…é–‹å§‹å¯èƒ½**: å³åº§ã«å¯èƒ½