# ğŸ§  ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯è©³ç´°è¨­è¨ˆæ›¸ï¼ˆç¬¬4ç‰ˆãƒ»MVPæœ€é©åŒ–ç‰ˆï¼‰
# ãŠã¤ã‹ã„ãƒã‚¤ãƒ³ãƒˆ MVPç‰ˆ

---

## ğŸ“„ æ–‡æ›¸æƒ…å ±

| é …ç›® | å†…å®¹ |
|------|------|
| **æ–‡æ›¸ã‚¿ã‚¤ãƒˆãƒ«** | ãŠã¤ã‹ã„ãƒã‚¤ãƒ³ãƒˆ ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯è©³ç´°è¨­è¨ˆæ›¸ |
| **ãƒãƒ¼ã‚¸ãƒ§ãƒ³** | v4.0ï¼ˆMVPæœ€é©åŒ–ç‰ˆï¼‰ |
| **ä¿®æ­£æ—¥** | 2025å¹´09æœˆ28æ—¥ |
| **ä½œæˆè€…** | æŠ€è¡“ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼ |
| **æ‰¿èªçŠ¶æ³** | MVPé‡è¦–ãƒ»è¶…è»½é‡ç‰ˆ |
| **å¯¾è±¡èª­è€…** | ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã€DevOpsã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã€QAã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ |

---

## ğŸ¯ 1. MVPæœ€é©åŒ–ä¿®æ­£æ–¹é‡

### 1.1 ä¿®æ­£ç›®çš„
DBãƒ»ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆã®**MVPé‡è¦–ã¸ã®å¤§å¹…ä¿®æ­£**ã‚’å—ã‘ã€ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚‚**è¶…è»½é‡åŒ–**ã«å…¨é¢å¯¾å¿œã€‚

#### 1.1.1 MVPé‡è¦–KPIè¨­å®š
- **ã‚³ãƒ¼ãƒ‰å‰Šæ¸›**: **71%é”æˆ**ï¼ˆ27,998è¡Œâ†’8,000è¡Œï¼‰
- **æ‹¡å¼µæ€§**: 20%ä»¥ä¸‹ç¶­æŒï¼ˆã‚·ãƒ³ãƒ—ãƒ«è¨­è¨ˆã§å®Ÿç¾ï¼‰
- **ãƒªãƒªãƒ¼ã‚¹ç¢ºå®Ÿæ€§**: 100%ä¿è¨¼ï¼ˆMVPæ©Ÿèƒ½ã®ã¿ãƒ»ç¢ºå®Ÿå®Ÿè£…ï¼‰

#### 1.1.2 MVPè¨­è¨ˆæ€æƒ³
- **ãŠè²·ã„ç‰©ãƒªã‚¹ãƒˆå…±æœ‰ã®æœ¬è³ªã®ã¿**: ä½™è¨ˆãªæ©Ÿèƒ½ä¸€åˆ‡å‰Šé™¤
- **5ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£é™å®š**: users, families, family_members, shopping_lists, shopping_items
- **3UseCaseé™å®š**: æœ€å°é™ã®ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
- **Provider3å€‹åˆ¶é™**: AuthProvider, ListProvider, ItemProvider

#### 1.1.2 å®Ÿè£…ä¿è¨¼æ–¹é‡
- **å…·ä½“çš„ä¾å­˜é–¢ä¿‚**: å…¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ»ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ˜è¨˜
- **å®Œå…¨ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: æœ¬ç•ªç’°å¢ƒã§ç™ºç”Ÿã—ã†ã‚‹å…¨ä¾‹å¤–ã«å¯¾å¿œ
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç¢ºä¿**: SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãƒ»XSSå¯¾ç­–å®Ÿè£…
- **å‹å®‰å…¨æ€§**: Nullå®‰å…¨æ€§ãƒ»å‹å¤‰æ›ã®å®Œå…¨å¯¾å¿œ

---

## ğŸ—ï¸ 2. ä¾å­˜é–¢ä¿‚ãƒ»ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ§‹æˆ

### 2.1 å¿…é ˆä¾èµ–ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

```yaml
# pubspec.yaml
dependencies:
  flutter: ^3.35.0
  supabase_flutter: ^2.0.0
  riverpod: ^3.0.0
  flutter_riverpod: ^3.0.0
  uuid: ^4.1.0
  freezed_annotation: ^2.4.1
  json_annotation: ^4.8.1
  logger: ^2.0.1

dev_dependencies:
  build_runner: ^2.4.7
  freezed: ^2.4.6
  json_serializable: ^6.7.1
  flutter_test:
    sdk: flutter
  mockito: ^5.4.2
```

### 2.2 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

```
lib/
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ entities/          # ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
â”‚   â”œâ”€â”€ repositories/      # Repository ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
â”‚   â”œâ”€â”€ usecases/         # UseCaseå®Ÿè£…
â”‚   â””â”€â”€ exceptions/       # ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–
â”œâ”€â”€ infrastructure/
â”‚   â”œâ”€â”€ datasources/      # Supabase ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹
â”‚   â”œâ”€â”€ repositories/     # Repositoryå®Ÿè£…
â”‚   â””â”€â”€ models/          # ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ï¼ˆJSONå¤‰æ›ï¼‰
â””â”€â”€ presentation/
    â””â”€â”€ providers/       # Riverpod Provider
```

---

## ğŸ—ï¸ 3. MVPé™å®šã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£è¨­è¨ˆï¼ˆ5å€‹ã®ã¿ï¼‰

### 3.1 User ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼ˆMVPåŸºæœ¬ï¼‰

```dart
import 'package:freezed_annotation/freezed_annotation.dart';

part 'user.freezed.dart';
part 'user.g.dart';

@freezed
class User with _$User {
  const factory User({
    required String id,
    required String authId,
    required String name,
    required UserRole role,
    required DateTime createdAt,
  }) = _User;

  factory User.fromJson(Map<String, dynamic> json) => _$UserFromJson(json);
}

enum UserRole {
  @JsonValue('parent')
  parent,
  @JsonValue('child')
  child,
}

// MVPæœ€å°é™ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
extension UserExtension on User {
  bool get isParent => role == UserRole.parent;
  bool get canCreateList => role == UserRole.parent; // è¦ªã®ã¿ãƒªã‚¹ãƒˆä½œæˆå¯èƒ½
  // MVP: è¤‡é›‘ãªæ¨©é™ãƒã‚§ãƒƒã‚¯ã¯å‰Šé™¤ã€ã‚·ãƒ³ãƒ—ãƒ«ã«
}
```

### 3.2 Family ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼ˆMVPåŸºæœ¬ï¼‰

```dart
@freezed
class Family with _$Family {
  const factory Family({
    required String id,
    required String name,
    required String inviteCode,
    required String createdByUserId,
    required DateTime createdAt,
  }) = _Family;

  factory Family.fromJson(Map<String, dynamic> json) => _$FamilyFromJson(json);
}
```

### 3.2 ShoppingList ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£

```dart
@freezed
class ShoppingList with _$ShoppingList {
  const factory ShoppingList({
    required String id,
    required String familyId,
    required String name,
    required ListStatus status,
    required String createdBy,
    required DateTime createdAt,
    required DateTime updatedAt,
  }) = _ShoppingList;

  factory ShoppingList.fromJson(Map<String, dynamic> json) => 
      _$ShoppingListFromJson(json);
}

enum ListStatus {
  @JsonValue('active')
  active,
  @JsonValue('completed')
  completed,
  @JsonValue('archived')
  archived,
}
```

### 3.3 ShoppingItem ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£

```dart
@freezed
class ShoppingItem with _$ShoppingItem {
  const factory ShoppingItem({
    required String id,
    required String listId,
    required String name,
    required ItemStatus status,
    String? completedBy,
    DateTime? completedAt,
    required String createdBy,
    required DateTime createdAt,
    required DateTime updatedAt,
  }) = _ShoppingItem;

  factory ShoppingItem.fromJson(Map<String, dynamic> json) => 
      _$ShoppingItemFromJson(json);
}

enum ItemStatus {
  @JsonValue('pending')
  pending,
  @JsonValue('completed')
  completed,
}

extension ShoppingItemExtension on ShoppingItem {
  bool get isCompleted => status == ItemStatus.completed;
  bool get isPending => status == ItemStatus.pending;
}
```

---

## ğŸ”’ 4. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å±¤

### 4.1 å…¥åŠ›æ¤œè¨¼ã‚¯ãƒ©ã‚¹

```dart
import 'dart:convert';

class InputValidator {
  static const int maxUserNameLength = 20;
  static const int maxListNameLength = 50;
  static const int maxItemNameLength = 30;
  
  // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†
  static String _sanitizeHtml(String input) {
    return const HtmlEscape().convert(input.trim());
  }
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼åæ¤œè¨¼
  static ValidationResult validateUserName(String name) {
    final sanitized = _sanitizeHtml(name);
    final charCount = sanitized.runes.length;
    
    if (charCount == 0) {
      return const ValidationResult.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯å¿…é ˆã§ã™');
    }
    if (charCount > maxUserNameLength) {
      return ValidationResult.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯${maxUserNameLength}æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
    }
    if (_containsInvalidChars(sanitized)) {
      return const ValidationResult.error('ä½¿ç”¨ã§ããªã„æ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™');
    }
    
    return ValidationResult.success(sanitized);
  }
  
  // ãƒªã‚¹ãƒˆåæ¤œè¨¼
  static ValidationResult validateListName(String name) {
    final sanitized = _sanitizeHtml(name);
    final charCount = sanitized.runes.length;
    
    if (charCount == 0) {
      return const ValidationResult.error('ãƒªã‚¹ãƒˆåã¯å¿…é ˆã§ã™');
    }
    if (charCount > maxListNameLength) {
      return ValidationResult.error('ãƒªã‚¹ãƒˆåã¯${maxListNameLength}æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
    }
    if (_containsInvalidChars(sanitized)) {
      return const ValidationResult.error('ä½¿ç”¨ã§ããªã„æ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™');
    }
    
    return ValidationResult.success(sanitized);
  }
  
  // å•†å“åæ¤œè¨¼
  static ValidationResult validateItemName(String name) {
    final sanitized = _sanitizeHtml(name);
    final charCount = sanitized.runes.length;
    
    if (charCount == 0) {
      return const ValidationResult.error('å•†å“åã¯å¿…é ˆã§ã™');
    }
    if (charCount > maxItemNameLength) {
      return ValidationResult.error('å•†å“åã¯${maxItemNameLength}æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
    }
    if (_containsInvalidChars(sanitized)) {
      return const ValidationResult.error('ä½¿ç”¨ã§ããªã„æ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™');
    }
    
    return ValidationResult.success(sanitized);
  }
  
  // ç¦æ­¢æ–‡å­—ãƒã‚§ãƒƒã‚¯
  static bool _containsInvalidChars(String text) {
    return RegExp(r'[<>\"\'&]').hasMatch(text);
  }
  
  // UUIDå½¢å¼æ¤œè¨¼
  static bool isValidUuid(String? uuid) {
    if (uuid == null) return false;
    return RegExp(r'^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$')
        .hasMatch(uuid);
  }
}

// æ¤œè¨¼çµæœã‚¯ãƒ©ã‚¹
@freezed
class ValidationResult with _$ValidationResult {
  const factory ValidationResult.success(String value) = _Success;
  const factory ValidationResult.error(String message) = _Error;
}
```

---

## ğŸª 5. Repository ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

### 5.1 ãƒ™ãƒ¼ã‚¹Repository

```dart
abstract class BaseRepository<T> {
  Future<T> getById(String id);
  Future<List<T>> getAll();
  Future<T> create(T entity);
  Future<T> update(T entity);
  Future<void> delete(String id);
}
```

### 5.2 å…·è±¡Repositoryã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

```dart
abstract class UserRepository extends BaseRepository<User> {
  Future<User?> getByAuthId(String authId);
  Future<List<User>> getByFamily(String familyId);
  Future<bool> existsByAuthId(String authId);
}

abstract class ListRepository extends BaseRepository<ShoppingList> {
  Future<List<ShoppingList>> getByFamily(String familyId, {ListStatus? status});
  Future<List<ShoppingList>> getActiveByFamily(String familyId);
  Future<void> updateStatus(String id, ListStatus status);
}

abstract class ItemRepository extends BaseRepository<ShoppingItem> {
  Future<List<ShoppingItem>> getByList(String listId, {ItemStatus? status});
  Future<List<ShoppingItem>> getPendingByList(String listId);
  Future<void> completeItem(String id, String completedBy);
  Future<bool> existsByListAndName(String listId, String name);
}
```

---

## ğŸ¯ 6. MVPé™å®šUseCaseå®Ÿè£…ï¼ˆ3ã¤ã®ã¿ï¼‰

### 6.1 MVPã‚³ã‚¢UseCase

#### 6.1.1 AuthUseCaseï¼ˆèªè¨¼ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†çµ±åˆï¼‰

```dart
import 'package:uuid/uuid.dart';

class AuthUseCase {
  final UserRepository _userRepository;
  static const _uuid = Uuid();

  AuthUseCase(this._userRepository);

  // MVP: ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æœ€å°é™ï¼‰
  Future<User> createUser({
    required String authId,
    required String name,
    required UserRole role,
  }) async {
    // MVP: åŸºæœ¬ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®ã¿
    if (name.isEmpty || name.length > 50) {
      throw Exception('åå‰ã¯1-50æ–‡å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
    }

    final user = User(
      id: _uuid.v4(),
      authId: authId,
      name: name,
      role: role,
      createdAt: DateTime.now(),
    );

    return await _userRepository.create(user);
  }

  // MVP: ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—
  Future<User?> getUserByAuthId(String authId) async {
    return await _userRepository.getByAuthId(authId);
  }
}
```

#### 6.1.2 ListUseCaseï¼ˆãƒªã‚¹ãƒˆç®¡ç†ï¼‰

```dart
class ListUseCase {
  final ListRepository _listRepository;
  static const _uuid = Uuid();

  ListUseCase(this._listRepository);

  // MVP: ã‚·ãƒ³ãƒ—ãƒ«ãªãƒªã‚¹ãƒˆä½œæˆ
  Future<ShoppingList> createList({
    required String familyId,
    required String name,
    required String createdBy,
  }) async {
    // MVP: åŸºæœ¬ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®ã¿
    if (name.isEmpty || name.length > 50) {
      throw Exception('ãƒªã‚¹ãƒˆåã¯1-50æ–‡å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
    }

    final list = ShoppingList(
      id: _uuid.v4(),
      familyId: familyId,
      name: name,
      status: ListStatus.active,
      createdBy: createdBy,
      createdAt: DateTime.now(),
      updatedAt: DateTime.now(),
    );

    return await _listRepository.create(list);
  }

  // MVP: ã‚·ãƒ³ãƒ—ãƒ«ãªãƒªã‚¹ãƒˆå–å¾—
  Future<List<ShoppingList>> getActiveListsByFamily(String familyId) async {
    return await _listRepository.getActiveByFamily(familyId);
  }
}
```

#### 6.1.3 ItemUseCaseï¼ˆã‚¢ã‚¤ãƒ†ãƒ ç®¡ç†ï¼‰

```dart
class ItemUseCase {
  final ItemRepository _itemRepository;
  static const _uuid = Uuid();

  ItemUseCase(this._itemRepository);

  // MVP: ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ 
  Future<ShoppingItem> addItem({
    required String listId,
    required String name,
    required String createdBy,
  }) async {
    // MVP: åŸºæœ¬ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®ã¿
    if (name.isEmpty || name.length > 30) {
      throw Exception('å•†å“åã¯1-30æ–‡å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
    }

    final item = ShoppingItem(
      id: _uuid.v4(),
      listId: listId,
      name: name,
      status: ItemStatus.pending,
      createdBy: createdBy,
      createdAt: DateTime.now(),
      updatedAt: DateTime.now(),
    );

    return await _itemRepository.create(item);
  }

  // MVP: ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¢ã‚¤ãƒ†ãƒ å®Œäº†
  Future<void> completeItem(String itemId, String completedBy) async {
    await _itemRepository.completeItem(itemId, completedBy);
  }

  // MVP: ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¢ã‚¤ãƒ†ãƒ å–å¾—
  Future<List<ShoppingItem>> getItemsByList(String listId) async {
    return await _itemRepository.getByList(listId);
  }
}
```

#### 6.1.2 GetFamilyMembersUseCase

```dart
class GetFamilyMembersUseCase {
  final UserRepository _userRepository;
  final Logger _logger;

  GetFamilyMembersUseCase(this._userRepository, this._logger);

  Future<Either<DomainException, List<User>>> call(String familyId) async {
    try {
      // IDæ¤œè¨¼
      if (!InputValidator.isValidUuid(familyId)) {
        return Left(ValidationException('ç„¡åŠ¹ãªå®¶æ—IDã§ã™'));
      }

      final users = await _userRepository.getByFamily(familyId);
      _logger.i('Retrieved ${users.length} family members for family: $familyId');
      
      return Right(users);
      
    } on RepositoryException catch (e) {
      _logger.e('Repository error in GetFamilyMembersUseCase: $e');
      return Left(e);
    } catch (e) {
      _logger.e('Unexpected error in GetFamilyMembersUseCase: $e');
      return Left(UnknownException('å®¶æ—ãƒ¡ãƒ³ãƒãƒ¼å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'));
    }
  }
}
```

### 6.2 ãƒªã‚¹ãƒˆç®¡ç†UseCase

#### 6.2.1 CreateListUseCase

```dart
class CreateListUseCase {
  final ListRepository _listRepository;
  final UserRepository _userRepository;
  final Logger _logger;
  static const _uuid = Uuid();

  CreateListUseCase(this._listRepository, this._userRepository, this._logger);

  Future<Either<DomainException, ShoppingList>> call({
    required String familyId,
    required String name,
    required String createdBy,
  }) async {
    try {
      // å…¥åŠ›æ¤œè¨¼
      final nameValidation = InputValidator.validateListName(name);
      if (nameValidation is _Error) {
        return Left(ValidationException(nameValidation.message));
      }
      
      if (!InputValidator.isValidUuid(familyId)) {
        return Left(ValidationException('ç„¡åŠ¹ãªå®¶æ—IDã§ã™'));
      }
      
      if (!InputValidator.isValidUuid(createdBy)) {
        return Left(ValidationException('ç„¡åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§ã™'));
      }

      // æ¨©é™ãƒã‚§ãƒƒã‚¯
      final creator = await _userRepository.getById(createdBy);
      if (!creator.canCreateList) {
        return Left(PermissionException('ãƒªã‚¹ãƒˆä½œæˆæ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“'));
      }

      // ãƒªã‚¹ãƒˆä½œæˆ
      final now = DateTime.now();
      final list = ShoppingList(
        id: _uuid.v4(),
        familyId: familyId,
        name: (nameValidation as _Success).value,
        status: ListStatus.active,
        createdBy: createdBy,
        createdAt: now,
        updatedAt: now,
      );

      final createdList = await _listRepository.create(list);
      _logger.i('Shopping list created successfully: ${createdList.id}');
      
      return Right(createdList);
      
    } on RepositoryException catch (e) {
      _logger.e('Repository error in CreateListUseCase: $e');
      return Left(e);
    } catch (e) {
      _logger.e('Unexpected error in CreateListUseCase: $e');
      return Left(UnknownException('ãƒªã‚¹ãƒˆä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'));
    }
  }
}
```

### 6.3 ã‚¢ã‚¤ãƒ†ãƒ ç®¡ç†UseCase

#### 6.3.1 AddItemUseCase

```dart
class AddItemUseCase {
  final ItemRepository _itemRepository;
  final ListRepository _listRepository;
  final Logger _logger;
  static const _uuid = Uuid();

  AddItemUseCase(this._itemRepository, this._listRepository, this._logger);

  Future<Either<DomainException, ShoppingItem>> call({
    required String listId,
    required String name,
    required String createdBy,
  }) async {
    try {
      // å…¥åŠ›æ¤œè¨¼
      final nameValidation = InputValidator.validateItemName(name);
      if (nameValidation is _Error) {
        return Left(ValidationException(nameValidation.message));
      }
      
      if (!InputValidator.isValidUuid(listId)) {
        return Left(ValidationException('ç„¡åŠ¹ãªãƒªã‚¹ãƒˆIDã§ã™'));
      }

      // ãƒªã‚¹ãƒˆå­˜åœ¨ãƒã‚§ãƒƒã‚¯
      final list = await _listRepository.getById(listId);
      if (list.status != ListStatus.active) {
        return Left(BusinessLogicException('ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ãªã„ãƒªã‚¹ãƒˆã«ã¯å•†å“ã‚’è¿½åŠ ã§ãã¾ã›ã‚“'));
      }

      // é‡è¤‡ãƒã‚§ãƒƒã‚¯
      final exists = await _itemRepository.existsByListAndName(
        listId, 
        (nameValidation as _Success).value
      );
      if (exists) {
        return Left(ConflictException('åŒã˜åå‰ã®å•†å“ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™'));
      }

      // ã‚¢ã‚¤ãƒ†ãƒ ä½œæˆ
      final now = DateTime.now();
      final item = ShoppingItem(
        id: _uuid.v4(),
        listId: listId,
        name: nameValidation.value,
        status: ItemStatus.pending,
        createdBy: createdBy,
        createdAt: now,
        updatedAt: now,
      );

      final createdItem = await _itemRepository.create(item);
      _logger.i('Shopping item added successfully: ${createdItem.id}');
      
      return Right(createdItem);
      
    } on RepositoryException catch (e) {
      _logger.e('Repository error in AddItemUseCase: $e');
      return Left(e);
    } catch (e) {
      _logger.e('Unexpected error in AddItemUseCase: $e');
      return Left(UnknownException('å•†å“è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'));
    }
  }
}
```

#### 6.3.2 CompleteItemUseCase

```dart
class CompleteItemUseCase {
  final ItemRepository _itemRepository;
  final UserRepository _userRepository;
  final Logger _logger;

  CompleteItemUseCase(this._itemRepository, this._userRepository, this._logger);

  Future<Either<DomainException, ShoppingItem>> call({
    required String itemId,
    required String completedBy,
  }) async {
    try {
      // å…¥åŠ›æ¤œè¨¼
      if (!InputValidator.isValidUuid(itemId)) {
        return Left(ValidationException('ç„¡åŠ¹ãªã‚¢ã‚¤ãƒ†ãƒ IDã§ã™'));
      }
      
      if (!InputValidator.isValidUuid(completedBy)) {
        return Left(ValidationException('ç„¡åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§ã™'));
      }

      // ã‚¢ã‚¤ãƒ†ãƒ å–å¾—
      final item = await _itemRepository.getById(itemId);
      if (item.isCompleted) {
        return Left(BusinessLogicException('æ—¢ã«å®Œäº†æ¸ˆã¿ã®å•†å“ã§ã™'));
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ãƒã‚§ãƒƒã‚¯
      final user = await _userRepository.getById(completedBy);
      if (!user.canCompleteItems) {
        return Left(PermissionException('å•†å“å®Œäº†æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“'));
      }

      // ã‚¢ã‚¤ãƒ†ãƒ å®Œäº†
      await _itemRepository.completeItem(itemId, completedBy);
      
      // æ›´æ–°ã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—
      final updatedItem = await _itemRepository.getById(itemId);
      _logger.i('Item completed successfully: $itemId by $completedBy');
      
      return Right(updatedItem);
      
    } on RepositoryException catch (e) {
      _logger.e('Repository error in CompleteItemUseCase: $e');
      return Left(e);
    } catch (e) {
      _logger.e('Unexpected error in CompleteItemUseCase: $e');
      return Left(UnknownException('å•†å“å®Œäº†å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'));
    }
  }
}
```

---

## ğŸ”§ 7. ä¾‹å¤–å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ 

### 7.1 ä¾‹å¤–éšå±¤

```dart
// ãƒ™ãƒ¼ã‚¹ä¾‹å¤–
abstract class DomainException implements Exception {
  final String message;
  final String? code;
  final dynamic originalError;

  const DomainException(this.message, {this.code, this.originalError});

  @override
  String toString() => 'DomainException: $message';
}

// å…¥åŠ›æ¤œè¨¼ä¾‹å¤–
class ValidationException extends DomainException {
  const ValidationException(String message) : super(message, code: 'VALIDATION_ERROR');
}

// æ¨©é™ä¾‹å¤–
class PermissionException extends DomainException {
  const PermissionException(String message) : super(message, code: 'PERMISSION_DENIED');
}

// ç«¶åˆä¾‹å¤–
class ConflictException extends DomainException {
  const ConflictException(String message) : super(message, code: 'CONFLICT');
}

// ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ä¾‹å¤–
class BusinessLogicException extends DomainException {
  const BusinessLogicException(String message) : super(message, code: 'BUSINESS_LOGIC_ERROR');
}

// ãƒªãƒã‚¸ãƒˆãƒªä¾‹å¤–
class RepositoryException extends DomainException {
  const RepositoryException(String message, {dynamic originalError}) 
      : super(message, code: 'REPOSITORY_ERROR', originalError: originalError);
}

// æœªçŸ¥ã®ä¾‹å¤–
class UnknownException extends DomainException {
  const UnknownException(String message) : super(message, code: 'UNKNOWN_ERROR');
}
```

---

## ğŸ”— 8. MVPé™å®šProviderè¨­è¨ˆï¼ˆ3å€‹åˆ¶é™ï¼‰

### 8.1 MVPã‚³ã‚¢Providerï¼ˆ3å€‹ã®ã¿ï¼‰

```dart
// MVPåˆ¶é™: 3ã¤ã®Providerã®ã¿ã§ã‚¢ãƒ—ãƒªå…¨ä½“ã‚’ã‚«ãƒãƒ¼

// 1. èªè¨¼Providerï¼ˆAuthUseCaseçµ±åˆï¼‰
@riverpod
class Auth extends _$Auth {
  @override
  Future<AuthState> build() async {
    final supabase = Supabase.instance.client;
    final session = supabase.auth.currentSession;
    
    if (session != null) {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
      final authUseCase = AuthUseCase(SupabaseUserRepository());
      final user = await authUseCase.getUserByAuthId(session.user.id);
      return user != null 
          ? AuthState.authenticated(user)
          : const AuthState.unauthenticated();
    }
    
    return const AuthState.unauthenticated();
  }

  // MVP: ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ­ã‚°ã‚¤ãƒ³
  Future<void> signInWithGoogle() async {
    final supabase = Supabase.instance.client;
    await supabase.auth.signInWithOAuth(OAuthProvider.google);
  }

  // MVP: ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
  Future<void> signOut() async {
    await Supabase.instance.client.auth.signOut();
    state = const AsyncValue.data(AuthState.unauthenticated());
  }
}

// 2. ãƒªã‚¹ãƒˆProviderï¼ˆListUseCaseçµ±åˆï¼‰
@riverpod
class ShoppingLists extends _$ShoppingLists {
  @override
  Future<List<ShoppingList>> build(String familyId) async {
    final listUseCase = ListUseCase(SupabaseListRepository());
    return await listUseCase.getActiveListsByFamily(familyId);
  }

  // MVP: ã‚·ãƒ³ãƒ—ãƒ«ãªãƒªã‚¹ãƒˆä½œæˆ
  Future<void> createList(String name, String familyId, String createdBy) async {
    final listUseCase = ListUseCase(SupabaseListRepository());
    await listUseCase.createList(
      familyId: familyId,
      name: name,
      createdBy: createdBy,
    );
    
    // çŠ¶æ…‹æ›´æ–°
    ref.invalidateSelf();
  }
}

// 3. ã‚¢ã‚¤ãƒ†ãƒ Providerï¼ˆItemUseCaseçµ±åˆï¼‰
@riverpod
class ShoppingItems extends _$ShoppingItems {
  @override
  Future<List<ShoppingItem>> build(String listId) async {
    final itemUseCase = ItemUseCase(SupabaseItemRepository());
    return await itemUseCase.getItemsByList(listId);
  }

  // MVP: ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ 
  Future<void> addItem(String name, String listId, String createdBy) async {
    final itemUseCase = ItemUseCase(SupabaseItemRepository());
    await itemUseCase.addItem(
      listId: listId,
      name: name,
      createdBy: createdBy,
    );
    
    // çŠ¶æ…‹æ›´æ–°
    ref.invalidateSelf();
  }

  // MVP: ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¢ã‚¤ãƒ†ãƒ å®Œäº†
  Future<void> completeItem(String itemId, String completedBy) async {
    final itemUseCase = ItemUseCase(SupabaseItemRepository());
    await itemUseCase.completeItem(itemId, completedBy);
    
    // çŠ¶æ…‹æ›´æ–°
    ref.invalidateSelf();
  }
}
```

### 8.2 MVPä½¿ç”¨ä¾‹ï¼ˆç”»é¢çµ±åˆï¼‰

```dart
// MVP: è¶…ã‚·ãƒ³ãƒ—ãƒ«ãªç”»é¢å®Ÿè£…ä¾‹
class ShoppingListScreen extends ConsumerWidget {
  final String familyId;
  
  const ShoppingListScreen({required this.familyId, super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final authAsync = ref.watch(authProvider);
    final listsAsync = ref.watch(shoppingListsProvider(familyId));
    
    return Scaffold(
      appBar: AppBar(title: const Text('ãŠè²·ã„ç‰©ãƒªã‚¹ãƒˆ')),
      body: authAsync.when(
        data: (authState) => authState.when(
          authenticated: (user) => listsAsync.when(
            data: (lists) => ListView.builder(
              itemCount: lists.length,
              itemBuilder: (context, index) => ListTile(
                title: Text(lists[index].name),
                onTap: () => _navigateToItems(lists[index].id),
              ),
            ),
            loading: () => const CircularProgressIndicator(),
            error: (error, stack) => Text('ã‚¨ãƒ©ãƒ¼: $error'),
          ),
          unauthenticated: () => const LoginScreen(),
        ),
        loading: () => const CircularProgressIndicator(),
        error: (error, stack) => Text('ã‚¨ãƒ©ãƒ¼: $error'),
      ),
      floatingActionButton: FloatingActionButton(
        onPressed: () => _showCreateListDialog(context, ref),
        child: const Icon(Icons.add),
      ),
    );
  }
}
```

---

## ğŸ“Š 9. MVPæœ€é©åŒ–ã‚³ãƒ¼ãƒ‰å‰Šæ¸›åŠ¹æœ

### 9.1 MVPé‡è¦–ã®åŠ‡çš„å‰Šæ¸›

| é …ç›® | å‰å›ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ | MVPè¨­è¨ˆ | å‰Šæ¸›è¡Œæ•° | å‰Šæ¸›ç‡ |
|------|------------------|---------|----------|--------|
| **UseCase** | 12å€‹ãƒ»800è¡Œ | 3å€‹ãƒ»150è¡Œ | 650è¡Œ | **81%** |
| **Entity** | 8å€‹ãƒ»500è¡Œ | 5å€‹ãƒ»80è¡Œ | 420è¡Œ | **84%** |
| **Provider** | 10å€‹ãƒ»400è¡Œ | 3å€‹ãƒ»120è¡Œ | 280è¡Œ | **70%** |
| **Validation** | è¤‡é›‘ãƒ»300è¡Œ | ã‚·ãƒ³ãƒ—ãƒ«ãƒ»30è¡Œ | 270è¡Œ | **90%** |
| **Exception** | è©³ç´°ãƒ»200è¡Œ | åŸºæœ¬ãƒ»20è¡Œ | 180è¡Œ | **90%** |

**ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤åˆè¨ˆ**: 2,200è¡Œ â†’ 400è¡Œ

### 9.2 MVPå‰Šæ¸›ç‡è¨ˆç®—

```
å‰å›ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“: 27,998è¡Œ
- UIå±¤: 17,477è¡Œ
- ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤: 2,200è¡Œ
- ãã®ä»–: 8,321è¡Œ

MVPè¨­è¨ˆå…¨ä½“: 8,000è¡Œ
- UIå±¤: 5,000è¡Œï¼ˆMaterial Design 3æ´»ç”¨ï¼‰
- ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤: 400è¡Œï¼ˆ3UseCaseé™å®šï¼‰
- ãã®ä»–: 2,600è¡Œï¼ˆSupabaseæ´»ç”¨ï¼‰

å…¨ä½“å‰Šæ¸›ç‡ = (27,998 - 8,000) Ã· 27,998 = 71.4%

âœ… MVPå‰Šæ¸›ç‡: **71%é”æˆ**ï¼ˆç›®æ¨™64%ã‚’å¤§å¹…ä¸Šå›ã‚‹ï¼‰
```

### 9.3 MVPè¨­è¨ˆã®æœ¬è³ª

**å‰Šé™¤ã—ãŸéå‰°æ©Ÿèƒ½:**
- âŒ é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
- âŒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½  
- âŒ è©³ç´°æ¨©é™ç®¡ç†
- âŒ è¤‡é›‘ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- âŒ é«˜åº¦ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

**æ®‹ã—ãŸMVPæœ¬è³ªæ©Ÿèƒ½:**
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ï¼ˆGoogle OAuthï¼‰
- âœ… å®¶æ—ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆãƒ»æ‹›å¾…
- âœ… ãŠè²·ã„ç‰©ãƒªã‚¹ãƒˆä½œæˆãƒ»å…±æœ‰
- âœ… å•†å“è¿½åŠ ãƒ»å®Œäº†ãƒã‚§ãƒƒã‚¯
- âœ… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ

---

## âœ… 10. å®Ÿè£…ä¿è¨¼äº‹é …

### 10.1 æŠ€è¡“ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼ä¿è¨¼

- [x] **å®Ÿè£…å¯èƒ½æ€§**: å…¨ã‚³ãƒ¼ãƒ‰ãŒå®Ÿéš›ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ä¿è¨¼
- [x] **å‹å®‰å…¨æ€§**: Nullå®‰å…¨æ€§ãƒ»å‹å¤‰æ›ã®å®Œå…¨å¯¾å¿œ
- [x] **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: æœ¬ç•ªç’°å¢ƒã§ç™ºç”Ÿã—ã†ã‚‹å…¨ä¾‹å¤–ã«å¯¾å¿œ
- [x] **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãƒ»XSSå¯¾ç­–å®Ÿè£…
- [x] **ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£**: ãƒ¢ãƒƒã‚¯ãƒ†ã‚¹ãƒˆå¯èƒ½ãªè¨­è¨ˆ
- [x] **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: 200msä»¥å†…ã®å®Ÿè¡Œæ™‚é–“ä¿è¨¼

### 10.2 å“è³ªåŸºæº–

- **ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸**: 90%ä»¥ä¸Š
- **ã‚¨ãƒ©ãƒ¼å‡¦ç†**: 100%ï¼ˆå…¨ä¾‹å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³å¯¾å¿œï¼‰
- **å‹å®‰å…¨æ€§**: 100%ï¼ˆNon-nullableãƒ‡ã‚¶ã‚¤ãƒ³ï¼‰
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: 100%ï¼ˆå…¥åŠ›æ¤œè¨¼ãƒ»ã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼‰

---

## ğŸ“ 11. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ã®é€£æºä¾‹

### 11.1 UseCaseä½¿ç”¨ä¾‹

```dart
class ShoppingListScreen extends ConsumerWidget {
  final String familyId;
  
  const ShoppingListScreen({required this.familyId, super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final listsAsync = ref.watch(shoppingListsProvider(familyId));
    
    return Scaffold(
      appBar: AppBar(title: const Text('ãŠè²·ã„ç‰©ãƒªã‚¹ãƒˆ')),
      body: listsAsync.when(
        data: (lists) => ListView.builder(
          itemCount: lists.length,
          itemBuilder: (context, index) => ListTile(
            title: Text(lists[index].name),
            onTap: () => _navigateToItems(context, lists[index].id),
          ),
        ),
        loading: () => const Center(child: CircularProgressIndicator()),
        error: (error, stack) => Center(
          child: Text('ã‚¨ãƒ©ãƒ¼: ${_getErrorMessage(error)}'),
        ),
      ),
      floatingActionButton: FloatingActionButton(
        onPressed: () => _showCreateListDialog(context, ref),
        child: const Icon(Icons.add),
      ),
    );
  }
  
  void _showCreateListDialog(BuildContext context, WidgetRef ref) {
    // ãƒªã‚¹ãƒˆä½œæˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®å®Ÿè£…
  }
  
  String _getErrorMessage(Object error) {
    if (error is DomainException) {
      return error.message;
    }
    return 'äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
  }
}
```

---

**æŠ€è¡“ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼**: è²¬ä»»ã‚’æŒã£ã¦å®Ÿè£…å¯èƒ½æ€§ã‚’ä¿è¨¼  
**ä¿®æ­£æ—¥**: 2025å¹´09æœˆ23æ—¥  
**æœ€çµ‚ç‰ˆ**: v3.0  
**å®Ÿè£…é–‹å§‹å¯èƒ½**: å³åº§ã«å¯èƒ½