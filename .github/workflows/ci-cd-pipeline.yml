# CI/CD Pipeline for ãŠã¤ã‹ã„ãƒã‚¤ãƒ³ãƒˆ MVP
# Flutter Android ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ãƒ¡ã‚¤ãƒ³ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

name: CI/CD Pipeline

on:
  push:
    branches: [develop, staging, main]
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - '.gitignore'
  pull_request:
    branches: [develop, main]
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - '.gitignore'

env:
  FLUTTER_VERSION: '3.35.0'
  JAVA_VERSION: '17'
  ANDROID_API_LEVEL: 34
  ANDROID_BUILD_TOOLS_VERSION: '34.0.0'
  COVERAGE_THRESHOLD: 90

jobs:
  # ===============================
  # ã‚³ãƒ¼ãƒ‰å“è³ªãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
  # ===============================
  code-quality:
    name: 'Code Quality & Security Analysis'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: Get dependencies
      run: flutter pub get

    - name: Verify dependencies
      run: flutter pub deps

    - name: Run Dart analyzer
      run: dart analyze --fatal-infos

    - name: Check code formatting
      run: dart format --output=none --set-exit-if-changed .

    - name: Run security analysis with Semgrep
      uses: semgrep/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/secrets
          p/owasp-top-ten
      env:
        SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_TOKEN }}

    - name: Upload security scan results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: semgrep.sarif

  # ===============================
  # ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãƒ»ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
  # ===============================
  test:
    name: 'Unit & Widget Tests'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: code-quality

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: Get dependencies
      run: flutter pub get

    - name: Run unit and widget tests
      run: |
        flutter test \
          --coverage \
          --test-randomize-ordering-seed=random \
          --reporter=expanded \
          --file-reporter=json:test-results.json

    - name: Generate coverage report
      run: |
        # Install lcov for coverage processing
        sudo apt-get update
        sudo apt-get install -y lcov
        
        # Generate HTML coverage report
        genhtml coverage/lcov.info -o coverage/html
        
        # Calculate coverage percentage
        COVERAGE=$(lcov --summary coverage/lcov.info 2>&1 | grep "lines......:" | cut -d':' -f2 | tr -d ' %')
        echo "COVERAGE_PERCENTAGE=$COVERAGE" >> $GITHUB_ENV
        echo "Coverage: $COVERAGE%"

    - name: Check coverage threshold
      run: |
        if (( $(echo "$COVERAGE_PERCENTAGE < $COVERAGE_THRESHOLD" | bc -l) )); then
          echo "âŒ Coverage $COVERAGE_PERCENTAGE% is below threshold $COVERAGE_THRESHOLD%"
          exit 1
        fi
        echo "âœ… Coverage $COVERAGE_PERCENTAGE% meets threshold $COVERAGE_THRESHOLD%"

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage/lcov.info
        flags: flutter
        name: flutter-tests
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          test-results.json
          coverage/
        retention-days: 7

  # ===============================
  # Android ãƒ“ãƒ«ãƒ‰ãƒ»çµ±åˆãƒ†ã‚¹ãƒˆ
  # ===============================
  build-android:
    name: 'Build Android APK'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [code-quality, test]

    strategy:
      matrix:
        environment: [development, staging, production]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: ${{ env.ANDROID_API_LEVEL }}
        build-tools: ${{ env.ANDROID_BUILD_TOOLS_VERSION }}

    - name: Get dependencies
      run: flutter pub get

    - name: Configure environment
      run: |
        # ç’°å¢ƒåˆ¥è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®é©ç”¨
        case "${{ matrix.environment }}" in
          "development")
            cp config/development.env .env
            echo "BUILD_MODE=debug" >> $GITHUB_ENV
            ;;
          "staging")
            cp config/staging.env .env
            echo "BUILD_MODE=profile" >> $GITHUB_ENV
            ;;
          "production")
            cp config/production.env .env
            echo "BUILD_MODE=release" >> $GITHUB_ENV
            ;;
        esac

    - name: Build Android APK
      run: |
        if [ "${{ matrix.environment }}" == "production" ]; then
          # æœ¬ç•ªç’°å¢ƒã¯ç½²åä»˜ãAPKä½œæˆ
          flutter build apk --release \
            --build-number=${{ github.run_number }} \
            --build-name="1.0.${{ github.run_number }}" \
            --dart-define=ENVIRONMENT=production
        else
          # é–‹ç™ºãƒ»ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒ
          flutter build apk --$BUILD_MODE \
            --build-number=${{ github.run_number }} \
            --build-name="1.0.${{ github.run_number }}-${{ matrix.environment }}" \
            --dart-define=ENVIRONMENT=${{ matrix.environment }}
        fi

    - name: Sign Android APK (Production only)
      if: matrix.environment == 'production'
      run: |
        echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/keystore.jks
        flutter build apk --release \
          --build-number=${{ github.run_number }} \
          --build-name="1.0.${{ github.run_number }}" \
          --dart-define=ENVIRONMENT=production

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: apk-${{ matrix.environment }}
        path: build/app/outputs/flutter-apk/*.apk
        retention-days: 14

    - name: Generate APK info
      run: |
        APK_PATH=$(find build/app/outputs/flutter-apk -name "*.apk" | head -1)
        APK_SIZE=$(stat -f%z "$APK_PATH" 2>/dev/null || stat -c%s "$APK_PATH")
        APK_SIZE_MB=$(echo "scale=2; $APK_SIZE / 1024 / 1024" | bc)
        
        echo "## ğŸ“± APK Build Info (${{ matrix.environment }})" >> $GITHUB_STEP_SUMMARY
        echo "- **File:** $(basename $APK_PATH)" >> $GITHUB_STEP_SUMMARY
        echo "- **Size:** ${APK_SIZE_MB} MB" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment:** ${{ matrix.environment }}" >> $GITHUB_STEP_SUMMARY

  # ===============================
  # çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆAndroidå®Ÿæ©Ÿãƒ†ã‚¹ãƒˆï¼‰
  # ===============================
  integration-test:
    name: 'Integration Tests'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: build-android
    if: github.event_name == 'push' && (github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/main')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: Enable KVM group perms
      run: |
        echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
        sudo udevadm control --reload-rules
        sudo udevadm trigger --name-match=kvm

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: ${{ env.ANDROID_API_LEVEL }}
        build-tools: ${{ env.ANDROID_BUILD_TOOLS_VERSION }}

    - name: Get dependencies
      run: flutter pub get

    - name: Run integration tests
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: ${{ env.ANDROID_API_LEVEL }}
        target: google_apis
        arch: x86_64
        profile: Nexus 6
        cores: 2
        ram-size: 4096M
        heap-size: 1024M
        script: |
          flutter drive \
            --driver=test_driver/integration_test.dart \
            --target=integration_test/app_test.dart \
            --device-id=emulator-5554 \
            --no-headless

    - name: Upload integration test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: |
          integration_test/screenshots/
          integration_test/logs/
        retention-days: 7

  # ===============================
  # é–‹ç™ºç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆFirebase App Distributionï¼‰
  # ===============================
  deploy-development:
    name: 'Deploy to Development'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build-android]
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download development APK
      uses: actions/download-artifact@v4
      with:
        name: apk-development
        path: ./artifacts/

    - name: Deploy to Firebase App Distribution
      uses: wzieba/Firebase-Distribution-Github-Action@v1
      with:
        appId: ${{ secrets.FIREBASE_APP_ID_ANDROID }}
        serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        groups: developers,qa-team
        file: artifacts/app-debug.apk
        releaseNotes: |
          ğŸš€ Development Build
          
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          **Build:** #${{ github.run_number }}
          
          **Changes:**
          ${{ github.event.head_commit.message }}

    - name: Notify Slack
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#otsukaipoint-dev'
        text: |
          ğŸš€ Developmentç‰ˆãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
          ãƒ“ãƒ«ãƒ‰ç•ªå·: ${{ github.run_number }}
          ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰: Firebase App Distribution
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ===============================
  # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒ‡ãƒ—ãƒ­ã‚¤
  # ===============================
  deploy-staging:
    name: 'Deploy to Staging'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [build-android, integration-test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/staging'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download staging APK
      uses: actions/download-artifact@v4
      with:
        name: apk-staging
        path: ./artifacts/

    - name: Deploy to Internal Testing Track
      uses: r0adkll/upload-google-play@v1
      with:
        serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
        packageName: com.otsukaipoint.app
        releaseFiles: artifacts/*.apk
        track: internal
        status: draft
        inAppUpdatePriority: 2
        whatsNewDirectory: release-notes/

    - name: Notify Slack
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#otsukaipoint-staging'
        text: |
          ğŸ¯ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç‰ˆãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
          ãƒ“ãƒ«ãƒ‰ç•ªå·: ${{ github.run_number }}
          Google Play Consoleå†…éƒ¨ãƒ†ã‚¹ãƒˆã§ç¢ºèªå¯èƒ½
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ===============================
  # æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤
  # ===============================
  deploy-production:
    name: 'Deploy to Production'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [build-android, integration-test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    environment:
      name: production
      url: https://play.google.com/store/apps/details?id=com.otsukaipoint.app

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download production APK
      uses: actions/download-artifact@v4
      with:
        name: apk-production
        path: ./artifacts/

    - name: Deploy to Production Track
      uses: r0adkll/upload-google-play@v1
      with:
        serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
        packageName: com.otsukaipoint.app
        releaseFiles: artifacts/*.apk
        track: production
        status: draft
        inAppUpdatePriority: 3
        whatsNewDirectory: release-notes/

    - name: Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v1.0.${{ github.run_number }}
        release_name: ãŠã¤ã‹ã„ãƒã‚¤ãƒ³ãƒˆ v1.0.${{ github.run_number }}
        body: |
          ## ğŸš€ æœ¬ç•ªãƒªãƒªãƒ¼ã‚¹ v1.0.${{ github.run_number }}
          
          ### ğŸ“± ã‚¢ãƒ—ãƒªæƒ…å ±
          - **ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ :** Android
          - **æœ€å°ã‚µãƒãƒ¼ãƒˆ:** Android 8.0 (API 26)
          - **ãƒ“ãƒ«ãƒ‰ç•ªå·:** ${{ github.run_number }}
          
          ### ğŸ”§ æŠ€è¡“è©³ç´°
          - **Flutter:** ${{ env.FLUTTER_VERSION }}
          - **ã‚³ãƒŸãƒƒãƒˆ:** ${{ github.sha }}
          - **ãƒ“ãƒ«ãƒ‰æ™‚åˆ»:** ${{ github.event.head_commit.timestamp }}
          
          ### ğŸ“‹ å¤‰æ›´å†…å®¹
          ${{ github.event.head_commit.message }}
        draft: false
        prerelease: false

    - name: Notify Slack
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#otsukaipoint-prod'
        text: |
          ğŸ‰ æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ï¼
          ãƒãƒ¼ã‚¸ãƒ§ãƒ³: v1.0.${{ github.run_number }}
          Google Play Consoleã§ç¢ºèªãƒ»å…¬é–‹å¯èƒ½
          
          ğŸ”— GitHub Release: https://github.com/soraharada/otsukaipoint2/releases/tag/v1.0.${{ github.run_number }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ===============================
  # ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—æ™‚ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
  # ===============================
  rollback:
    name: 'Emergency Rollback'
    runs-on: ubuntu-latest
    if: failure() && (needs.deploy-staging.result == 'failure' || needs.deploy-production.result == 'failure')
    needs: [deploy-staging, deploy-production]

    steps:
    - name: Notify emergency
      uses: 8398a7/action-slack@v3
      with:
        status: 'failure'
        channel: '#otsukaipoint-alerts'
        text: |
          ğŸš¨ ç·Šæ€¥: ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—
          
          æ‰‹å‹•å¯¾å¿œãŒå¿…è¦ã§ã™ï¼š
          1. Google Play Consoleã§ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
          2. å½±éŸ¿èª¿æŸ»ãƒ»åŸå› ç‰¹å®š
          3. ä¿®æ­£ç‰ˆã®æº–å‚™
          
          ãƒ“ãƒ«ãƒ‰: ${{ github.run_number }}
          ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}