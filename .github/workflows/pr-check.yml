# Pull Request Check Workflow
# PRä½œæˆãƒ»æ›´æ–°æ™‚ã®å“è³ªãƒã‚§ãƒƒã‚¯ç”¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

name: Pull Request Check

on:
  pull_request:
    branches: [develop, main]
    types: [opened, synchronize, reopened]

env:
  FLUTTER_VERSION: '3.35.0'
  JAVA_VERSION: '17'
  COVERAGE_THRESHOLD: 90

jobs:
  # ===============================
  # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«åˆ†æž
  # ===============================
  analyze-changes:
    name: 'Analyze Changes'
    runs-on: ubuntu-latest
    outputs:
      has-dart-changes: ${{ steps.changes.outputs.dart }}
      has-android-changes: ${{ steps.changes.outputs.android }}
      has-test-changes: ${{ steps.changes.outputs.test }}
      has-config-changes: ${{ steps.changes.outputs.config }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Detect changes
      uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          dart:
            - 'lib/**/*.dart'
            - 'pubspec.yaml'
          android:
            - 'android/**/*'
            - 'android/app/build.gradle'
          test:
            - 'test/**/*'
            - 'integration_test/**/*'
          config:
            - '.github/**/*'
            - 'analysis_options.yaml'
            - 'pubspec.yaml'

    - name: Comment PR with analysis
      uses: actions/github-script@v7
      with:
        script: |
          const changes = {
            dart: ${{ steps.changes.outputs.dart }},
            android: ${{ steps.changes.outputs.android }},
            test: ${{ steps.changes.outputs.test }},
            config: ${{ steps.changes.outputs.config }}
          };
          
          let comment = '## ðŸ” å¤‰æ›´åˆ†æžçµæžœ\n\n';
          
          if (changes.dart) comment += '- âœ… Dartã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ã‚’æ¤œå‡º\n';
          if (changes.android) comment += '- âœ… Androidãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å›ºæœ‰ã®å¤‰æ›´ã‚’æ¤œå‡º\n';
          if (changes.test) comment += '- âœ… ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ã‚’æ¤œå‡º\n';
          if (changes.config) comment += '- âœ… è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã‚’æ¤œå‡º\n';
          
          comment += '\nðŸ“‹ å®Ÿè¡Œäºˆå®šãƒã‚§ãƒƒã‚¯:\n';
          comment += '- ã‚³ãƒ¼ãƒ‰å“è³ªè§£æž\n';
          comment += '- ãƒ¦ãƒ‹ãƒƒãƒˆãƒ»ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆãƒ†ã‚¹ãƒˆ\n';
          if (changes.dart || changes.android) comment += '- APKãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ\n';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  # ===============================
  # ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
  # ===============================
  code-quality:
    name: 'Code Quality Check'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: Get dependencies
      run: flutter pub get

    - name: Run Dart analyzer
      run: |
        echo "## ðŸ“Š Dart Analyzerçµæžœ" >> $GITHUB_STEP_SUMMARY
        
        if flutter analyze --no-fatal-infos > analyzer_output.txt 2>&1; then
          echo "âœ… **è§£æžçµæžœ**: å•é¡Œãªã—" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **è§£æžçµæžœ**: å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat analyzer_output.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi

    - name: Check code formatting
      run: |
        echo "## ðŸŽ¨ ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆçµæžœ" >> $GITHUB_STEP_SUMMARY
        
        if dart format --output=none --set-exit-if-changed .; then
          echo "âœ… **ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ**: é©åˆ‡ã«ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã™" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ**: ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã®ä¿®æ­£ãŒå¿…è¦ã§ã™" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ä¿®æ­£ã‚³ãƒžãƒ³ãƒ‰: \`dart format .\`" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi

    - name: Check import sorting
      run: |
        # import_sorterã‚’ä½¿ç”¨ã—ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆé †åºã‚’ãƒã‚§ãƒƒã‚¯
        flutter pub global activate import_sorter
        
        if flutter pub global run import_sorter:main --no-comments --exit-if-changed; then
          echo "âœ… **ã‚¤ãƒ³ãƒãƒ¼ãƒˆé †åº**: é©åˆ‡ã«æ•´ç†ã•ã‚Œã¦ã„ã¾ã™" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **ã‚¤ãƒ³ãƒãƒ¼ãƒˆé †åº**: ã‚¤ãƒ³ãƒãƒ¼ãƒˆã®æ•´ç†ãŒå¿…è¦ã§ã™" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ä¿®æ­£ã‚³ãƒžãƒ³ãƒ‰: \`flutter pub global run import_sorter:main\`" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi

  # ===============================
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
  # ===============================
  security-scan:
    name: 'Security Scan'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: analyze-changes
    if: needs.analyze-changes.outputs.has-dart-changes == 'true'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Semgrep security analysis
      uses: semgrep/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/secrets
          p/owasp-top-ten
          p/dart
        generate_config_file: semgrep.yml

    - name: Comment security results
      uses: actions/github-script@v7
      if: always()
      with:
        script: |
          const fs = require('fs');
          let comment = '## ðŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæžœ\n\n';
          
          try {
            if (fs.existsSync('semgrep.sarif')) {
              const sarif = JSON.parse(fs.readFileSync('semgrep.sarif', 'utf8'));
              const results = sarif.runs[0]?.results || [];
              
              if (results.length === 0) {
                comment += 'âœ… **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œ**: æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ\n';
              } else {
                comment += `âŒ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œ**: ${results.length}ä»¶ã®å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ\n\n`;
                
                results.slice(0, 5).forEach((result, index) => {
                  const ruleId = result.ruleId;
                  const message = result.message.text;
                  const location = result.locations[0]?.physicalLocation?.artifactLocation?.uri || 'Unknown';
                  
                  comment += `${index + 1}. **${ruleId}**\n`;
                  comment += `   - ãƒ•ã‚¡ã‚¤ãƒ«: ${location}\n`;
                  comment += `   - è©³ç´°: ${message}\n\n`;
                });
                
                if (results.length > 5) {
                  comment += `... ãŠã‚ˆã³ ${results.length - 5} ä»¶ã®è¿½åŠ å•é¡Œ\n`;
                }
              }
            } else {
              comment += 'âœ… **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³**: æ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ\n';
            }
          } catch (error) {
            comment += 'âš ï¸ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³**: çµæžœã®è§£æžã«å¤±æ•—ã—ã¾ã—ãŸ\n';
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  # ===============================
  # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ»ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒã‚§ãƒƒã‚¯
  # ===============================
  test:
    name: 'Test & Coverage'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: Get dependencies
      run: flutter pub get

    - name: Run tests with coverage
      run: |
        flutter test \
          --coverage \
          --test-randomize-ordering-seed=random \
          --reporter=expanded \
          --file-reporter=json:test-results.json

    - name: Process coverage results
      run: |
        sudo apt-get update
        sudo apt-get install -y lcov
        
        # HTML coverage reportç”Ÿæˆ
        genhtml coverage/lcov.info -o coverage/html
        
        # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸è¨ˆç®—
        COVERAGE=$(lcov --summary coverage/lcov.info 2>&1 | grep "lines......:" | cut -d':' -f2 | tr -d ' %')
        echo "COVERAGE_PERCENTAGE=$COVERAGE" >> $GITHUB_ENV
        
        # GitHub Step Summaryã«çµæžœã‚’å‡ºåŠ›
        echo "## ðŸ“Š ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸çµæžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ã‚«ãƒãƒ¬ãƒƒã‚¸:** $COVERAGE%" >> $GITHUB_STEP_SUMMARY
        echo "**é–¾å€¤:** $COVERAGE_THRESHOLD%" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if (( $(echo "$COVERAGE < $COVERAGE_THRESHOLD" | bc -l) )); then
          echo "âŒ **åˆ¤å®š:** é–¾å€¤ã‚’ä¸‹å›žã£ã¦ã„ã¾ã™" >> $GITHUB_STEP_SUMMARY
          echo "STATUS=failed" >> $GITHUB_ENV
        else
          echo "âœ… **åˆ¤å®š:** é–¾å€¤ã‚’æº€ãŸã—ã¦ã„ã¾ã™" >> $GITHUB_STEP_SUMMARY
          echo "STATUS=passed" >> $GITHUB_ENV
        fi

    - name: Upload coverage reports
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage/lcov.info
        flags: pr-check
        name: pr-coverage

    - name: Comment test results
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const coverage = process.env.COVERAGE_PERCENTAGE;
          const threshold = process.env.COVERAGE_THRESHOLD;
          const status = process.env.STATUS;
          
          let comment = '## ðŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæžœ\n\n';
          
          // ãƒ†ã‚¹ãƒˆçµæžœã®èª­ã¿è¾¼ã¿
          try {
            if (fs.existsSync('test-results.json')) {
              const testResults = JSON.parse(fs.readFileSync('test-results.json', 'utf8'));
              const successCount = testResults.success || 0;
              const failureCount = testResults.failure || 0;
              const totalTests = successCount + failureCount;
              
              comment += `**å®Ÿè¡Œãƒ†ã‚¹ãƒˆæ•°:** ${totalTests}\n`;
              comment += `**æˆåŠŸ:** ${successCount} âœ…\n`;
              comment += `**å¤±æ•—:** ${failureCount} ${failureCount > 0 ? 'âŒ' : 'âœ…'}\n\n`;
            }
          } catch (error) {
            comment += '**ãƒ†ã‚¹ãƒˆçµæžœ:** çµæžœãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—\n\n';
          }
          
          // ã‚«ãƒãƒ¬ãƒƒã‚¸çµæžœ
          comment += `**ã‚«ãƒãƒ¬ãƒƒã‚¸:** ${coverage}% ${status === 'passed' ? 'âœ…' : 'âŒ'}\n`;
          comment += `**å¿…è¦ã‚«ãƒãƒ¬ãƒƒã‚¸:** ${threshold}%\n\n`;
          
          if (status === 'failed') {
            comment += 'âš ï¸ **ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚**\n';
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: Fail if coverage is insufficient
      if: env.STATUS == 'failed'
      run: |
        echo "âŒ Coverage $COVERAGE_PERCENTAGE% is below threshold $COVERAGE_THRESHOLD%"
        exit 1

  # ===============================
  # ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆï¼ˆå¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
  # ===============================
  build-test:
    name: 'Build Test'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [analyze-changes, code-quality, test]
    if: needs.analyze-changes.outputs.has-dart-changes == 'true' || needs.analyze-changes.outputs.has-android-changes == 'true'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: Get dependencies
      run: flutter pub get

    - name: Build Android APK (Debug)
      run: |
        flutter build apk --debug \
          --build-number=${{ github.event.number }} \
          --build-name="pr-${{ github.event.number }}" \
          --dart-define=ENVIRONMENT=development

    - name: Check APK size
      run: |
        APK_PATH="build/app/outputs/flutter-apk/app-debug.apk"
        APK_SIZE=$(stat -c%s "$APK_PATH")
        APK_SIZE_MB=$(echo "scale=2; $APK_SIZE / 1024 / 1024" | bc)
        
        echo "APK_SIZE_MB=$APK_SIZE_MB" >> $GITHUB_ENV
        
        echo "## ðŸ“± ãƒ“ãƒ«ãƒ‰çµæžœ" >> $GITHUB_STEP_SUMMARY
        echo "**APKã‚µã‚¤ã‚º:** ${APK_SIZE_MB} MB" >> $GITHUB_STEP_SUMMARY
        
        # ã‚µã‚¤ã‚ºãŒ100MBã‚’è¶…ãˆãŸå ´åˆã¯è­¦å‘Š
        if (( $(echo "$APK_SIZE_MB > 100" | bc -l) )); then
          echo "âš ï¸ **è­¦å‘Š:** APKã‚µã‚¤ã‚ºãŒå¤§ãã™ãŽã¾ã™" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **APKã‚µã‚¤ã‚º:** é©åˆ‡ãªç¯„å›²å†…" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Comment build results
      uses: actions/github-script@v7
      with:
        script: |
          const apkSize = process.env.APK_SIZE_MB;
          
          let comment = '## ðŸ“± ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆçµæžœ\n\n';
          comment += `**ãƒ“ãƒ«ãƒ‰:** âœ… æˆåŠŸ\n`;
          comment += `**APKã‚µã‚¤ã‚º:** ${apkSize} MB\n`;
          
          if (parseFloat(apkSize) > 100) {
            comment += '\nâš ï¸ **è­¦å‘Š:** APKã‚µã‚¤ã‚ºãŒå¤§ãã™ãŽã¾ã™ã€‚ãƒªã‚½ãƒ¼ã‚¹ã‚„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®æœ€é©åŒ–ã‚’æ¤œè¨Žã—ã¦ãã ã•ã„ã€‚\n';
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  # ===============================
  # æœ€çµ‚çµæžœã‚µãƒžãƒªãƒ¼
  # ===============================
  summary:
    name: 'PR Check Summary'
    runs-on: ubuntu-latest
    needs: [analyze-changes, code-quality, security-scan, test, build-test]
    if: always()

    steps:
    - name: Generate final summary
      uses: actions/github-script@v7
      with:
        script: |
          const results = {
            'code-quality': '${{ needs.code-quality.result }}',
            'security-scan': '${{ needs.security-scan.result }}',
            'test': '${{ needs.test.result }}',
            'build-test': '${{ needs.build-test.result }}'
          };
          
          let comment = '## ðŸ“‹ PR ãƒã‚§ãƒƒã‚¯å®Œäº†ã‚µãƒžãƒªãƒ¼\n\n';
          
          Object.entries(results).forEach(([job, result]) => {
            const emoji = result === 'success' ? 'âœ…' : 
                         result === 'failure' ? 'âŒ' : 
                         result === 'skipped' ? 'â­ï¸' : 'âš ï¸';
            
            const jobName = {
              'code-quality': 'ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯',
              'security-scan': 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³',
              'test': 'ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ',
              'build-test': 'ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ'
            }[job];
            
            comment += `- ${emoji} **${jobName}**: ${result}\n`;
          });
          
          const allPassed = Object.values(results).every(result => 
            result === 'success' || result === 'skipped'
          );
          
          comment += '\n---\n';
          
          if (allPassed) {
            comment += 'ðŸŽ‰ **ç·åˆåˆ¤å®š:** âœ… å…¨ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n';
            comment += '\nâœ¨ ã“ã®PRã¯ãƒžãƒ¼ã‚¸å¯èƒ½ã§ã™ã€‚';
          } else {
            comment += 'âš ï¸ **ç·åˆåˆ¤å®š:** âŒ ä¿®æ­£ãŒå¿…è¦ãªé …ç›®ãŒã‚ã‚Šã¾ã™ã€‚\n';
            comment += '\nðŸ”§ ä¸Šè¨˜ã®å¤±æ•—é …ç›®ã‚’ä¿®æ­£ã—ã¦ã‹ã‚‰å†åº¦ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ãã ã•ã„ã€‚';
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: Set PR status
      uses: actions/github-script@v7
      with:
        script: |
          const results = {
            'code-quality': '${{ needs.code-quality.result }}',
            'security-scan': '${{ needs.security-scan.result }}',
            'test': '${{ needs.test.result }}',
            'build-test': '${{ needs.build-test.result }}'
          };
          
          const allPassed = Object.values(results).every(result => 
            result === 'success' || result === 'skipped'
          );
          
          if (!allPassed) {
            core.setFailed('One or more PR checks failed');
          }