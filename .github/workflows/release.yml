# Release Management Workflow
# ãƒªãƒªãƒ¼ã‚¹ãƒ»ãƒ›ãƒƒãƒˆãƒ•ã‚£ãƒƒã‚¯ã‚¹ç®¡ç†ç”¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

name: Release Management

on:
  release:
    types: [published]
  push:
    tags:
      - 'v*.*.*'
      - 'hotfix-*'
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'patch'
        type: choice
        options:
          - major
          - minor
          - patch
          - hotfix
      release_notes:
        description: 'Release notes'
        required: false
        type: string

env:
  FLUTTER_VERSION: '3.35.0'
  JAVA_VERSION: '17'

jobs:
  # ===============================
  # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ±ºå®š
  # ===============================
  prepare-release:
    name: 'Prepare Release'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      is-hotfix: ${{ steps.version.outputs.is-hotfix }}
      release-notes: ${{ steps.notes.outputs.notes }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Determine version
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          # æ‰‹å‹•å®Ÿè¡Œã®å ´åˆ
          RELEASE_TYPE="${{ github.event.inputs.release_type }}"
          
          # æœ€æ–°ã‚¿ã‚°ã‚’å–å¾—
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          
          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’æŠ½å‡º
          VERSION=$(echo $LATEST_TAG | sed 's/v//')
          IFS='.' read -ra VERSION_PARTS <<< "$VERSION"
          
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}
          
          case $RELEASE_TYPE in
            major)
              NEW_VERSION="$((MAJOR+1)).0.0"
              ;;
            minor)
              NEW_VERSION="$MAJOR.$((MINOR+1)).0"
              ;;
            patch)
              NEW_VERSION="$MAJOR.$MINOR.$((PATCH+1))"
              ;;
            hotfix)
              NEW_VERSION="$MAJOR.$MINOR.$((PATCH+1))"
              echo "is-hotfix=true" >> $GITHUB_OUTPUT
              ;;
          esac
          
          NEW_TAG="v$NEW_VERSION"
          
        elif [[ "${{ github.event_name }}" == "push" ]]; then
          # ã‚¿ã‚°ãƒ—ãƒƒã‚·ãƒ¥ã®å ´åˆ
          NEW_TAG="${{ github.ref_name }}"
          NEW_VERSION=$(echo $NEW_TAG | sed 's/v//')
          
          if [[ $NEW_TAG == hotfix-* ]]; then
            echo "is-hotfix=true" >> $GITHUB_OUTPUT
          fi
          
        elif [[ "${{ github.event_name }}" == "release" ]]; then
          # GitHub Releaseä½œæˆã®å ´åˆ
          NEW_TAG="${{ github.event.release.tag_name }}"
          NEW_VERSION=$(echo $NEW_TAG | sed 's/v//')
        fi
        
        echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT
        
        echo "ğŸ“‹ æ±ºå®šã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³: $NEW_VERSION"
        echo "ğŸ“‹ æ±ºå®šã•ã‚ŒãŸã‚¿ã‚°: $NEW_TAG"

    - name: Prepare release notes
      id: notes
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          NOTES="${{ github.event.inputs.release_notes }}"
          if [[ -z "$NOTES" ]]; then
            NOTES="Release ${{ steps.version.outputs.version }}"
          fi
        elif [[ "${{ github.event_name }}" == "release" ]]; then
          NOTES="${{ github.event.release.body }}"
        else
          # ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ã‹ã‚‰è‡ªå‹•ç”Ÿæˆ
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          if [[ -n "$PREVIOUS_TAG" ]]; then
            NOTES=$(git log --oneline $PREVIOUS_TAG..HEAD --pretty=format:"- %s" | head -20)
          else
            NOTES="Initial release"
          fi
        fi
        
        # ãƒãƒ«ãƒãƒ©ã‚¤ãƒ³å¯¾å¿œ
        {
          echo "notes<<EOF"
          echo "$NOTES"
          echo "EOF"
        } >> $GITHUB_OUTPUT

  # ===============================
  # ãƒªãƒªãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰
  # ===============================
  build-release:
    name: 'Build Release'
    runs-on: ubuntu-latest
    needs: prepare-release
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: Get dependencies
      run: flutter pub get

    - name: Update version in pubspec.yaml
      run: |
        VERSION="${{ needs.prepare-release.outputs.version }}"
        BUILD_NUMBER="${{ github.run_number }}"
        
        # pubspec.yamlã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›´æ–°
        sed -i "s/^version: .*/version: $VERSION+$BUILD_NUMBER/" pubspec.yaml
        
        echo "ğŸ“± Updated version to: $VERSION+$BUILD_NUMBER"

    - name: Build production APK
      run: |
        echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/keystore.jks
        
        flutter build apk --release \
          --build-number=${{ github.run_number }} \
          --build-name="${{ needs.prepare-release.outputs.version }}" \
          --dart-define=ENVIRONMENT=production \
          --obfuscate \
          --split-debug-info=build/app/outputs/symbols

    - name: Build App Bundle (AAB)
      run: |
        flutter build appbundle --release \
          --build-number=${{ github.run_number }} \
          --build-name="${{ needs.prepare-release.outputs.version }}" \
          --dart-define=ENVIRONMENT=production \
          --obfuscate \
          --split-debug-info=build/app/outputs/symbols

    - name: Generate checksums
      run: |
        cd build/app/outputs/flutter-apk/
        sha256sum *.apk > checksums.txt
        
        cd ../bundle/release/
        sha256sum *.aab >> ../../flutter-apk/checksums.txt
        
        echo "## ğŸ“¦ Build Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### APK Files" >> $GITHUB_STEP_SUMMARY
        ls -la build/app/outputs/flutter-apk/*.apk | while read line; do
          echo "- $(echo $line | awk '{print $9}') ($(echo $line | awk '{print $5}') bytes)" >> $GITHUB_STEP_SUMMARY
        done
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### App Bundle Files" >> $GITHUB_STEP_SUMMARY
        ls -la build/app/outputs/bundle/release/*.aab | while read line; do
          echo "- $(echo $line | awk '{print $9}') ($(echo $line | awk '{print $5}') bytes)" >> $GITHUB_STEP_SUMMARY
        done

    - name: Upload release artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-artifacts
        path: |
          build/app/outputs/flutter-apk/*.apk
          build/app/outputs/bundle/release/*.aab
          build/app/outputs/flutter-apk/checksums.txt
          build/app/outputs/symbols/
        retention-days: 90

  # ===============================
  # ãƒªãƒªãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ
  # ===============================
  release-test:
    name: 'Release Test'
    runs-on: ubuntu-latest
    needs: [prepare-release, build-release]
    timeout-minutes: 45

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: Download release artifacts
      uses: actions/download-artifact@v4
      with:
        name: release-artifacts
        path: ./release-artifacts/

    - name: Get dependencies
      run: flutter pub get

    - name: Run comprehensive tests
      run: |
        echo "## ğŸ§ª ãƒªãƒªãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆçµæœ" >> $GITHUB_STEP_SUMMARY
        
        # ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
        flutter test --coverage --reporter=expanded
        
        # ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ç¢ºèª
        sudo apt-get update && sudo apt-get install -y lcov
        COVERAGE=$(lcov --summary coverage/lcov.info 2>&1 | grep "lines......:" | cut -d':' -f2 | tr -d ' %')
        
        echo "**ã‚«ãƒãƒ¬ãƒƒã‚¸:** $COVERAGE%" >> $GITHUB_STEP_SUMMARY
        
        if (( $(echo "$COVERAGE < 90" | bc -l) )); then
          echo "âŒ **ã‚«ãƒãƒ¬ãƒƒã‚¸ä¸è¶³:** ãƒªãƒªãƒ¼ã‚¹ã«ã¯90%ä»¥ä¸Šå¿…è¦" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
        
        echo "âœ… **ã‚«ãƒãƒ¬ãƒƒã‚¸:** è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã™" >> $GITHUB_STEP_SUMMARY

    - name: APK integrity check
      run: |
        # APKã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
        cd release-artifacts
        
        if sha256sum -c checksums.txt; then
          echo "âœ… **APKæ•´åˆæ€§:** å•é¡Œãªã—" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **APKæ•´åˆæ€§:** ãƒã‚§ãƒƒã‚¯ã‚µãƒ ä¸ä¸€è‡´" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi

    - name: Security scan on release build
      uses: semgrep/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/owasp-top-ten
          p/secrets
      continue-on-error: false

  # ===============================
  # GitHub Releaseä½œæˆ
  # ===============================
  create-github-release:
    name: 'Create GitHub Release'
    runs-on: ubuntu-latest
    needs: [prepare-release, build-release, release-test]
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download release artifacts
      uses: actions/download-artifact@v4
      with:
        name: release-artifacts
        path: ./release-artifacts/

    - name: Create Git tag
      if: github.event_name == 'workflow_dispatch'
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git tag -a "${{ needs.prepare-release.outputs.tag }}" -m "Release ${{ needs.prepare-release.outputs.version }}"
        git push origin "${{ needs.prepare-release.outputs.tag }}"

    - name: Create GitHub Release
      uses: actions/create-release@v1
      id: create_release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ needs.prepare-release.outputs.tag }}
        release_name: ãŠã¤ã‹ã„ãƒã‚¤ãƒ³ãƒˆ ${{ needs.prepare-release.outputs.tag }}
        body: |
          ## ğŸš€ ãƒªãƒªãƒ¼ã‚¹ ${{ needs.prepare-release.outputs.version }}
          
          ### ğŸ“± ã‚¢ãƒ—ãƒªæƒ…å ±
          - **ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** ${{ needs.prepare-release.outputs.version }}
          - **ãƒ“ãƒ«ãƒ‰ç•ªå·:** ${{ github.run_number }}
          - **ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ :** Android
          - **æœ€å°ã‚µãƒãƒ¼ãƒˆ:** Android 8.0 (API 26)
          
          ### ğŸ”§ æŠ€è¡“æƒ…å ±
          - **Flutter:** ${{ env.FLUTTER_VERSION }}
          - **ã‚³ãƒŸãƒƒãƒˆ:** ${{ github.sha }}
          - **ãƒ“ãƒ«ãƒ‰æ™‚åˆ»:** ${{ github.event.head_commit.timestamp }}
          
          ### ğŸ“‹ å¤‰æ›´å†…å®¹
          ${{ needs.prepare-release.outputs.release-notes }}
          
          ### ğŸ“¦ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          - **APK (æ¨å¥¨):** app-release.apk
          - **App Bundle:** app-release.aab
          - **Checksums:** checksums.txt
          
          ### âš ï¸ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ³¨æ„äº‹é …
          1. ä¸æ˜ãªæä¾›å…ƒã‹ã‚‰ã®ã‚¢ãƒ—ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è¨±å¯ã—ã¦ãã ã•ã„
          2. Google Play Protectè­¦å‘Šã¯ã€Œã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€ã‚’é¸æŠã—ã¦ãã ã•ã„
          3. åˆå›èµ·å‹•æ™‚ã¯Google OAuthèªè¨¼ãŒå¿…è¦ã§ã™
        draft: ${{ needs.prepare-release.outputs.is-hotfix == 'true' }}
        prerelease: ${{ needs.prepare-release.outputs.is-hotfix == 'true' }}

    - name: Upload APK to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release-artifacts/app-release.apk
        asset_name: ãŠã¤ã‹ã„ãƒã‚¤ãƒ³ãƒˆ-${{ needs.prepare-release.outputs.version }}.apk
        asset_content_type: application/vnd.android.package-archive

    - name: Upload App Bundle to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release-artifacts/app-release.aab
        asset_name: ãŠã¤ã‹ã„ãƒã‚¤ãƒ³ãƒˆ-${{ needs.prepare-release.outputs.version }}.aab
        asset_content_type: application/octet-stream

    - name: Upload checksums to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release-artifacts/checksums.txt
        asset_name: checksums.txt
        asset_content_type: text/plain

  # ===============================
  # Google Play Store ãƒ‡ãƒ—ãƒ­ã‚¤
  # ===============================
  deploy-playstore:
    name: 'Deploy to Play Store'
    runs-on: ubuntu-latest
    needs: [prepare-release, build-release, release-test]
    if: needs.prepare-release.outputs.is-hotfix != 'true'

    environment:
      name: production
      url: https://play.google.com/console

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download release artifacts
      uses: actions/download-artifact@v4
      with:
        name: release-artifacts
        path: ./release-artifacts/

    - name: Deploy to Google Play Console
      uses: r0adkll/upload-google-play@v1
      with:
        serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
        packageName: com.otsukaipoint.app
        releaseFiles: release-artifacts/app-release.aab
        track: production
        status: completed
        inAppUpdatePriority: 3
        whatsNewDirectory: release-notes/
        mappingFile: release-artifacts/symbols/app.android-arm64.symbols

    - name: Notify deployment success
      uses: 8398a7/action-slack@v3
      with:
        status: 'success'
        channel: '#otsukaipoint-prod'
        text: |
          ğŸ‰ Google Play Storeãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ï¼
          
          **ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** ${{ needs.prepare-release.outputs.version }}
          **ãƒ“ãƒ«ãƒ‰:** ${{ github.run_number }}
          **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:** æœ¬ç•ªç’°å¢ƒå…¬é–‹æ¸ˆã¿
          
          ğŸ“± Google Play Storeã§ç¢ºèªå¯èƒ½
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ===============================
  # ãƒ›ãƒƒãƒˆãƒ•ã‚£ãƒƒã‚¯ã‚¹ãƒ‡ãƒ—ãƒ­ã‚¤
  # ===============================
  deploy-hotfix:
    name: 'Deploy Hotfix'
    runs-on: ubuntu-latest
    needs: [prepare-release, build-release, release-test]
    if: needs.prepare-release.outputs.is-hotfix == 'true'

    environment:
      name: hotfix
      url: https://play.google.com/console

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download release artifacts
      uses: actions/download-artifact@v4
      with:
        name: release-artifacts
        path: ./release-artifacts/

    - name: Deploy hotfix to internal testing
      uses: r0adkll/upload-google-play@v1
      with:
        serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
        packageName: com.otsukaipoint.app
        releaseFiles: release-artifacts/app-release.aab
        track: internal
        status: draft
        inAppUpdatePriority: 5
        whatsNewDirectory: release-notes/

    - name: Notify hotfix deployment
      uses: 8398a7/action-slack@v3
      with:
        status: 'warning'
        channel: '#otsukaipoint-alerts'
        text: |
          ğŸš¨ ãƒ›ãƒƒãƒˆãƒ•ã‚£ãƒƒã‚¯ã‚¹é…ä¿¡æº–å‚™å®Œäº†
          
          **ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** ${{ needs.prepare-release.outputs.version }}
          **ç¨®åˆ¥:** ç·Šæ€¥ä¿®æ­£
          **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:** å†…éƒ¨ãƒ†ã‚¹ãƒˆç‰ˆã¨ã—ã¦é…ä¿¡æº–å‚™å®Œäº†
          
          âš ï¸ æ¤œè¨¼å¾Œã«æ‰‹å‹•ã§æœ¬ç•ªå…¬é–‹ã—ã¦ãã ã•ã„
          ğŸ“‹ Google Play Console: https://play.google.com/console
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ===============================
  # ãƒªãƒªãƒ¼ã‚¹å®Œäº†é€šçŸ¥
  # ===============================
  notify-completion:
    name: 'Notify Release Completion'
    runs-on: ubuntu-latest
    needs: [prepare-release, create-github-release, deploy-playstore]
    if: always() && needs.create-github-release.result == 'success'

    steps:
    - name: Send completion notification
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#otsukaipoint-releases'
        text: |
          ğŸŠ ãƒªãƒªãƒ¼ã‚¹å‡¦ç†å®Œäº†ï¼
          
          **ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** ${{ needs.prepare-release.outputs.version }}
          **GitHub Release:** âœ… ä½œæˆæ¸ˆã¿
          **Google Play Store:** ${{ needs.deploy-playstore.result == 'success' && 'âœ… å…¬é–‹æ¸ˆã¿' || 'â³ å‡¦ç†ä¸­' }}
          
          ğŸ”— **ãƒªãƒ³ã‚¯:**
          - [GitHub Release](https://github.com/soraharada/otsukaipoint2/releases/tag/${{ needs.prepare-release.outputs.tag }})
          - [Google Play Console](https://play.google.com/console)
          
          ğŸ‘ ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}